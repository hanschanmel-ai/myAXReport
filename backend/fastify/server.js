const fastify=require('fastify')({logger:true})
const {PrismaClient}=require('@prisma/client')
const jwt=require('@fastify/jwt')
const bcrypt=require('bcryptjs')
const cors=require('@fastify/cors')
const prisma=new PrismaClient()
fastify.register(cors,{origin:true})
fastify.register(jwt,{secret:process.env.JWT_SECRET||'change-me'})
function auth(req,res,done){try{req.jwtVerify();done()}catch(e){res.code(401).send({error:'Unauthorized'})}}
async function hasRole(req,role){const user=await prisma.user.findUnique({where:{email:req.user.email},include:{roles:{include:{role:true}}}});const names=(user.roles||[]).map(r=>r.role.name);return names.includes(role)}
fastify.get('/',async()=>({ok:true,service:'ai-erp-fastify'}))
fastify.post('/auth/login',async(req,res)=>{const {email,password}=req.body||{};const user=await prisma.user.findUnique({where:{email}});if(!user){res.code(401);return {error:'Invalid credentials'}}const ok=await bcrypt.compare(password||'',user.passwordHash);if(!ok){res.code(401);return {error:'Invalid credentials'}}const token=fastify.jwt.sign({email:user.email,name:user.name});return {token}})
fastify.get('/auth/login',async(req,res)=>{return {hint:'Use POST /auth/login with { email, password } and Content-Type: application/json' }})
fastify.get('/auth/me',{preHandler:auth},async(req,res)=>{const user=await prisma.user.findUnique({where:{email:req.user.email},include:{roles:{include:{role:true}}}});return {email:user.email,name:user.name,roles:(user.roles||[]).map(r=>r.role.name)}})
fastify.get('/health',async()=>({ok:true}))
fastify.get('/companies',async(req,res)=>{const rows=await prisma.company.findMany();return rows})
fastify.post('/companies',{preHandler:auth},async(req,res)=>{if(!(await hasRole(req,'admin'))){res.code(403);return {error:'Forbidden'}}const {code,name,currency,tz}=req.body||{};if(!code||!name||!currency||!tz){res.code(400);return {error:'Missing fields'}}const exists=await prisma.company.findUnique({where:{code}});if(exists){res.code(400);return {error:'Company code exists'}}const row=await prisma.company.create({data:{code,name,currency,tz}});return row})
fastify.get('/items',async(req,res)=>{const rows=await prisma.item.findMany();return rows})
fastify.post('/items',{preHandler:auth},async(req,res)=>{if(!(await hasRole(req,'inventory'))){res.code(403);return {error:'Forbidden'}}const {sku,name,uom}=req.body||{};if(!sku||!name||!uom){res.code(400);return {error:'Missing fields'}}const exists=await prisma.item.findUnique({where:{sku}});if(exists){res.code(400);return {error:'SKU exists'}}const row=await prisma.item.create({data:{sku,name,uom}});return row})
fastify.get('/inventory/balances',{preHandler:auth},async(req,res)=>{const rows=await prisma.inventoryBalance.findMany();return rows})
fastify.post('/gl/post',{preHandler:auth},async(req,res)=>{if(!(await hasRole(req,'accountant'))){res.code(403);return {error:'Forbidden'}}const {companyCode,date,lines,reference}=req.body||{};if(!companyCode||!Array.isArray(lines)||lines.length===0){res.code(400);return {error:'Missing company or lines'}}const entry=await prisma.glEntry.create({data:{companyCode,date:new Date(date||new Date()),reference,status:'posted',lines:{create:lines.map(l=>({account:l.account_code||l.account||'',debit:l.debit||0,credit:l.credit||0,desc:l.desc||''}))}}});return entry})
fastify.get('/gl/entries',{preHandler:auth},async(req,res)=>{const {company_code}=req.query||{};const where=company_code?{companyCode:company_code}:{ };const rows=await prisma.glEntry.findMany({where,include:{lines:true}});return rows})
async function nextNumber(entity,companyCode){const y=new Date().getFullYear().toString();const pad=n=>String(n).padStart(5,'0');if(entity==='PO'){const c=await prisma.purchaseOrder.count({where:{companyCode}});return `PO-${companyCode}-${y}-${pad(c+1)}`}if(entity==='SO'){const c=await prisma.salesOrder.count({where:{companyCode}});return `SO-${companyCode}-${y}-${pad(c+1)}`}const c=await prisma.glEntry.count({where:{companyCode}});return `GL-${companyCode}-${y}-${pad(c+1)}`}
fastify.get('/api/purchase/orders',{preHandler:auth},async(req,res)=>{const {company_code}=req.query||{};const where=company_code?{companyCode:company_code}:{ };const rows=await prisma.purchaseOrder.findMany({where,include:{lines:true}});return rows})
fastify.post('/api/purchase/orders',{preHandler:auth},async(req,res)=>{if(!(await hasRole(req,'inventory'))){res.code(403);return {error:'Forbidden'}}const {company_code,vendor,lines}=req.body||{};if(!company_code||!vendor||!Array.isArray(lines)||lines.length===0){res.code(400);return {error:'Missing fields'}}const poNumber=await nextNumber('PO',company_code);const row=await prisma.purchaseOrder.create({data:{poNumber,companyCode:company_code,vendorCode:vendor,status:'open',lines:{create:(lines||[]).map(l=>({sku:String(l.sku||''),qty:Number(l.qty||0),price:Number(l.price||0)}))}}});return {id:row.id,po_number:row.poNumber,company_code:row.companyCode,vendor:row.vendorCode,lines:lines,status:row.status,date:row.date.toISOString().slice(0,10)}})
fastify.post('/api/purchase/receive',{preHandler:auth},async(req,res)=>{if(!(await hasRole(req,'inventory'))){res.code(403);return {error:'Forbidden'}}const {company_code,po_number,location}=req.body||{};if(!company_code||!po_number||!location){res.code(400);return {error:'Missing fields'}}const po=await prisma.purchaseOrder.findUnique({where:{poNumber:po_number},include:{lines:true}});if(!po||po.companyCode!==company_code){res.code(404);return {error:'PO not found'}}for(const line of po.lines){const sku=line.sku;const qty=Number(line.qty||0);const price=Number(line.price||0);const key={companyCode:company_code,location,itemSku:sku};let bal=await prisma.inventoryBalance.findFirst({where:key});if(!bal){bal=await prisma.inventoryBalance.create({data:Object.assign({},key,{qtyOnHand:0,avgCost:0})})}const prevQty=Number(bal.qtyOnHand||0);const newQty=prevQty+qty;const newAvg=newQty>0?((prevQty*Number(bal.avgCost||0)+qty*price)/newQty):price;await prisma.inventoryBalance.update({where:{id:bal.id},data:{qtyOnHand:newQty,avgCost:newAvg}})}await prisma.purchaseOrder.update({where:{id:po.id},data:{status:'received'}});const glNumber=await nextNumber('GL',company_code);const gl=await prisma.glEntry.create({data:{glNumber:glNumber,companyCode:company_code,date:new Date(),reference:po_number,status:'posted',lines:{create:po.lines.filter(l=>Number(l.price||0)>0).map(l=>{const amt=Number(l.price||0)*Number(l.qty||0);return [{account:'1200',debit:amt,credit:0,desc:'PO Receipt'},{account:'2200',debit:0,credit:amt,desc:'AP Clearing'}]}).flat()}}});return {ok:true,po_number:po_number,gl_number:gl.glNumber}})
fastify.get('/api/sales/orders',{preHandler:auth},async(req,res)=>{const {company_code}=req.query||{};const where=company_code?{companyCode:company_code}:{ };const rows=await prisma.salesOrder.findMany({where,include:{lines:true}});return rows})
fastify.post('/api/sales/orders',{preHandler:auth},async(req,res)=>{if(!(await hasRole(req,'inventory'))){res.code(403);return {error:'Forbidden'}}const {company_code,customer,lines}=req.body||{};if(!company_code||!customer||!Array.isArray(lines)||lines.length===0){res.code(400);return {error:'Missing fields'}}const soNumber=await nextNumber('SO',company_code);const row=await prisma.salesOrder.create({data:{soNumber,companyCode:company_code,customerCode:customer,status:'open',lines:{create:(lines||[]).map(l=>({sku:String(l.sku||''),qty:Number(l.qty||0)}))}}});return {id:row.id,so_number:row.soNumber,company_code:row.companyCode,customer:row.customerCode,lines:lines,status:row.status,date:row.date.toISOString().slice(0,10)}})
fastify.post('/api/sales/ship',{preHandler:auth},async(req,res)=>{if(!(await hasRole(req,'inventory'))){res.code(403);return {error:'Forbidden'}}const {company_code,so_number,location}=req.body||{};if(!company_code||!so_number||!location){res.code(400);return {error:'Missing fields'}}const so=await prisma.salesOrder.findUnique({where:{soNumber:so_number},include:{lines:true}});if(!so||so.companyCode!==company_code){res.code(404);return {error:'SO not found'}}for(const line of so.lines){const sku=line.sku;const qty=Number(line.qty||0);const key={companyCode:company_code,location,itemSku:sku};let bal=await prisma.inventoryBalance.findFirst({where:key});if(!bal){bal=await prisma.inventoryBalance.create({data:Object.assign({},key,{qtyOnHand:0,avgCost:0})})}const newQty=Number(bal.qtyOnHand||0)-qty;await prisma.inventoryBalance.update({where:{id:bal.id},data:{qtyOnHand:newQty<0?0:newQty}})}await prisma.salesOrder.update({where:{id:so.id},data:{status:'shipped'}});const glNumber=await nextNumber('GL',company_code);const lines=[];for(const line of so.lines){const key={companyCode:company_code,location,itemSku:line.sku};const bal=await prisma.inventoryBalance.findFirst({where:key});const unit=Number(bal&&bal.avgCost||0);const amt=unit*Number(line.qty||0);if(amt>0){lines.push({account:'5000',debit:amt,credit:0,desc:'Issue to SO'});lines.push({account:'1200',debit:0,credit:amt,desc:'Inventory'})}}const gl=await prisma.glEntry.create({data:{glNumber:glNumber,companyCode:company_code,date:new Date(),reference:so_number,status:'posted',lines:{create:lines}}});return {ok:true,so_number:so_number,gl_number:gl.glNumber}})
// Aliases to match /api/* shape used by static UI
fastify.get('/api/inventory/balances',{preHandler:auth},async(req,res)=>{const rows=await prisma.inventoryBalance.findMany();return rows})
fastify.post('/api/items',{preHandler:auth},async(req,res)=>{const {sku,name,uom}=req.body||{};if(!sku||!name||!uom){res.code(400);return {error:'Missing fields'}}const exists=await prisma.item.findUnique({where:{sku}});if(exists){res.code(400);return {error:'SKU exists'}}const row=await prisma.item.create({data:{sku,name,uom}});return row})
fastify.post('/api/gl/post',{preHandler:auth},async(req,res)=>{return fastify.inject({method:'POST',url:'/gl/post',payload:req.body}).then(r=>JSON.parse(r.payload))})
fastify.get('/api/gl/entries',{preHandler:auth},async(req,res)=>{return fastify.inject({method:'GET',url:'/gl/entries',query:req.query}).then(r=>JSON.parse(r.payload))})
// Vendors
fastify.get('/api/vendors',{preHandler:auth},async(req,res)=>{const rows=await prisma.vendor.findMany();return rows})
fastify.post('/api/vendors',{preHandler:auth},async(req,res)=>{if(!(await hasRole(req,'admin'))){res.code(403);return {error:'Forbidden'}}const {code,name}=req.body||{};if(!code||!name){res.code(400);return {error:'Vendor code and name required'}}const exists=await prisma.vendor.findUnique({where:{code}});if(exists){res.code(400);return {error:'Vendor code exists'}}const row=await prisma.vendor.create({data:{code,name}});return row})
// Customers
fastify.get('/api/customers',{preHandler:auth},async(req,res)=>{const rows=await prisma.customer.findMany();return rows})
fastify.post('/api/customers',{preHandler:auth},async(req,res)=>{if(!(await hasRole(req,'admin'))){res.code(403);return {error:'Forbidden'}}const {code,name}=req.body||{};if(!code||!name){res.code(400);return {error:'Customer code and name required'}}const exists=await prisma.customer.findUnique({where:{code}});if(exists){res.code(400);return {error:'Customer code exists'}}const row=await prisma.customer.create({data:{code,name}});return row})
const PORT=parseInt(process.env.FASTIFY_PORT||'8789',10)
fastify.listen({port:PORT,host:'127.0.0.1'}).catch(err=>{fastify.log.error(err);process.exit(1)})
