const http=require('node:http');
const fs=require('node:fs');
const path=require('node:path');
const { parse: parseUrl } = require('node:url');

const PORT=8787;
const ROOT=__dirname;
const CFG_PATH=path.join(ROOT,'rates-config.json');
const ERP_DIR=path.join(ROOT,'erp-data');
const COMP_PATH=path.join(ERP_DIR,'companies.json');
const ACC_PATH=path.join(ERP_DIR,'accounts.json');
const ITEM_PATH=path.join(ERP_DIR,'items.json');
const ITEM_DETAIL_PATH=path.join(ERP_DIR,'items-details.json');
const INV_PATH=path.join(ERP_DIR,'inventory.json');
const GL_PATH=path.join(ERP_DIR,'gl.json');
const SER_PATH=path.join(ERP_DIR,'series.json');
const LOC_PATH=path.join(ERP_DIR,'locations.json');
const BIN_PATH=path.join(ERP_DIR,'bins.json');
const PER_PATH=path.join(ERP_DIR,'periods.json');
const FIFO_PATH=path.join(ERP_DIR,'fifo.json');

function readBody(req){return new Promise(r=>{let d='';req.on('data',c=>d+=c);req.on('end',()=>r(d));});}
function send(res,status,body,type){res.writeHead(status,{'Content-Type':type||'application/json'});res.end(body);} 
function readCfg(){try{return JSON.parse(fs.readFileSync(CFG_PATH,'utf8'));}catch(e){return {currency:'HKD',service_standard_name:'VKS Standard',service_express_name:'VKS Express',default_threshold_hkd:0,default_fee_hkd:0,default_threshold_op:'lt',express:{type:'multiplier',value:1.5,free_when_standard_free:true},area_overrides:{}}}}
function writeCfg(cfg){fs.writeFileSync(CFG_PATH,JSON.stringify(cfg,null,2),'utf8');}

function getDistricts(){return {regions:{'Hong Kong Island':['Central and Western','Wan Chai','Eastern','Southern'],'Kowloon':['Yau Tsim Mong','Sham Shui Po','Kowloon City','Wong Tai Sin','Kwun Tong'],'New Territories':['Tsuen Wan','Tuen Mun','Yuen Long','North','Tai Po','Sha Tin','Kwai Tsing','Sai Kung','Islands']}}}

function inDateRange(now,from,to){if(from){const f=new Date(from);if(now<f)return false}if(to){const t=new Date(to);if(now>t)return false}return true}
function pickOverride(cfg,country,region,district){const ov=cfg.area_overrides||{};const keys=[`${(country||'HK')}/${region||''}/${district||''}`.toLowerCase(),`${(country||'HK')}/${region||''}`.toLowerCase(),`${(country||'HK')}`.toLowerCase(),`${district||''}`.toLowerCase(),`${region||''}`.toLowerCase()];for(const k of keys){if(ov[k])return ov[k]}return null}
function shouldApply(op,threshold,subtotal){if(typeof threshold!=='number')return false;if((op||'lt')==='lt')return subtotal<threshold;return subtotal>=threshold}
function calcRates(cfg,body){const dest=(body.rate&&body.rate.destination)||{};const items=(body.rate&&body.rate.items)||[];let subtotalHkd=0,grams=0,count=0;items.forEach(i=>{subtotalHkd+=(i.price||0)/100*(i.quantity||0);grams+=(i.grams||0)*(i.quantity||0);count+=(i.quantity||0)});const district=(dest.city||'').toLowerCase();const region=(dest.province||dest.region||'').toLowerCase();const override=pickOverride(cfg,'HK',region,district)||{};const now=new Date();let std=0;if(override.active!==false&&(!override.min_weight_grams||grams>=override.min_weight_grams)&&(!override.max_weight_grams||grams<=override.max_weight_grams)&&(!override.min_items||count>=override.min_items)&&(!override.max_items||count<=override.max_items)&&inDateRange(now,override.active_from,override.active_to)){const op=override.threshold_op||cfg.default_threshold_op||'lt';const th=typeof override.threshold_hkd==='number'?override.threshold_hkd:(cfg.default_threshold_hkd||0);const fe=typeof override.fee_hkd==='number'?override.fee_hkd:(cfg.default_fee_hkd||0);std= th===0?fe:(shouldApply(op,th,subtotalHkd)?fe:0)}const exp=(override.express||cfg.express||null);let ex=null;if(exp){if(exp.free_when_standard_free&&std===0){ex=0}else if((exp.type||'multiplier')==='multiplier'){ex=Math.round(std*(exp.value||1))}else{ex=Math.round(exp.value||0)}}const currency=(cfg.currency||'HKD');const rates=[];rates.push({service_name:(cfg.service_standard_name||'VKS Standard'),service_code:'standard',currency,total_price:Math.round(std*100)});if(ex!==null){rates.push({service_name:(cfg.service_express_name||'VKS Express'),service_code:'express',currency,total_price:Math.round(ex*100)})}return {rates}}

function parseCSV(text){const lines=text.split(/\r?\n/).filter(l=>l.trim().length>0);if(lines.length===0)return [];
  let start=0;const header=lines[0].toLowerCase();if(header.includes('district')||header.includes('region')||header.includes('threshold'))start=1;
  const rows=[];for(let i=start;i<lines.length;i++){const raw=lines[i];const parts=raw.split(',').map(s=>s.trim().replace(/^"|"$/g,''));if(parts.length<3)continue;const country=(parts[0]||'HK');const region=(parts[1]||'');const district=(parts[2]||'');const threshold=parts[3]?Number(parts[3]):NaN;const fee=parts[4]?Number(parts[4]):NaN;const active=parts[5]?String(parts[5]).toLowerCase()!=='false':true;rows.push({country,region,district,threshold_hkd:Number.isNaN(threshold)?undefined:threshold,fee_hkd:Number.isNaN(fee)?undefined:fee,active});}
  return rows;
}

// ERP helpers
function ensureErp(){
  try{fs.mkdirSync(ERP_DIR,{recursive:true});}catch(e){}
  const initRows=fn=>{
    try{fs.accessSync(fn);}catch(e){
      fs.writeFileSync(fn,JSON.stringify({nextId:1,rows:[]},null,2),'utf8')
    }
  };
  initRows(COMP_PATH);initRows(ACC_PATH);initRows(ITEM_PATH);initRows(INV_PATH);initRows(GL_PATH);initRows(LOC_PATH);initRows(BIN_PATH);initRows(PER_PATH);initRows(ITEM_DETAIL_PATH);
  try{fs.accessSync(SER_PATH);}catch(e){fs.writeFileSync(SER_PATH,JSON.stringify({},null,2),'utf8')}
}
ensureErp();
try{fs.accessSync(FIFO_PATH)}catch(e){fs.writeFileSync(FIFO_PATH,JSON.stringify({rows:[]},null,2),'utf8')}
function readJson(p){try{return JSON.parse(fs.readFileSync(p,'utf8'))}catch(e){return {nextId:1,rows:[]}}}
function writeJson(p,obj){fs.writeFileSync(p,JSON.stringify(obj,null,2),'utf8')}
function fifoKey(company_code,location,item_sku){return company_code+'|'+location+'|'+item_sku}
function fifoGet(company_code,location,item_sku){try{const db=JSON.parse(fs.readFileSync(FIFO_PATH,'utf8'));const key=fifoKey(company_code,location,item_sku);const row=(db.rows||[]).find(r=>r.key===key);return row?row.layers:[];}catch(e){return []}}
function fifoSet(company_code,location,item_sku,layers){const db=JSON.parse(fs.readFileSync(FIFO_PATH,'utf8'));const key=fifoKey(company_code,location,item_sku);const idx=(db.rows||[]).findIndex(r=>r.key===key);const row={key,layers};if(idx>=0){db.rows[idx]=row}else{db.rows.push(row)}fs.writeFileSync(FIFO_PATH,JSON.stringify(db,null,2),'utf8')}
const TYPE_CATEGORY={
  'Bank':'asset','Credit Card':'liability','Accounts Receivable':'asset','Accounts Payable':'liability',
  'Other Current Asset':'asset','Other Asset':'asset','Fixed Asset':'asset','Other Current Liability':'liability','Long Term Liability':'liability','Equity':'equity',
  'Deferred Revenue':'liability','Deferred Expense':'asset','Unbilled Receivable':'asset','Income':'income','Other Income':'other_income','Expense':'expense','Other Expense':'other_expense','Cost of Goods Sold':'cogs'
};
const CATEGORY_RANGE={asset:[1000,1999],liability:[2000,2999],equity:[3000,3999],income:[4000,4999],cogs:[5000,5999],expense:[6000,7999],other_income:[8000,8499],other_expense:[8500,8999]};
function validateAccountNumber(type,code){const cat=TYPE_CATEGORY[type]||null;const num=parseInt(code,10);if(!Number.isFinite(num))return {ok:false,error:'Account code must be numeric'};if(!cat)return {ok:true};const range=CATEGORY_RANGE[cat];if(!range)return {ok:true};if(num<range[0]||num>range[1])return {ok:false,error:`${type} should be numbered ${range[0]}â€“${range[1]}`};return {ok:true}}
function computeDepth(rows,a){let depth=0;let current=a;const byCode=new Map(rows.map(r=>[r.code,r]));while(current&&current.parent){current=byCode.get(current.parent);if(current)depth++;else break}return depth}

function periodKey(dateStr){const d=new Date(dateStr||new Date());const y=d.getFullYear();const m=d.getMonth()+1;return `${y}-${String(m).padStart(2,'0')}`}
function isPeriodOpen(company_code,dateStr){const db=readJson(PER_PATH);const key=periodKey(dateStr);const row=(db.rows||[]).find(r=>r.company_code===company_code&&r.key===key);if(!row) return true;return row.status!=='closed'}

function serveStatic(req,res,p){let f=path.join(ROOT,decodeURIComponent(p));if(f.endsWith('/'))f=path.join(f,'index.html');if(!f.startsWith(ROOT))return send(res,403,'Forbidden','text/plain');fs.stat(f,(e,st)=>{if(e||!st.isFile())return send(res,404,'Not Found','text/plain');const ext=path.extname(f).toLowerCase();const types={'.html':'text/html','.js':'application/javascript','.css':'text/css','.json':'application/json','.xml':'application/xml','.txt':'text/plain','.png':'image/png','.jpg':'image/jpeg','.jpeg':'image/jpeg','.svg':'image/svg+xml'};fs.readFile(f,(err,data)=>{if(err)return send(res,500,'Error','text/plain');send(res,200,data,types[ext]||'application/octet-stream')});});}

const server=http.createServer(async(req,res)=>{
  const u=parseUrl(req.url,true);
  // ERP API
  if(req.method==='GET'&&u.pathname==='/api/companies'){const db=readJson(COMP_PATH);return send(res,200,JSON.stringify(db.rows||[]))}
  if(req.method==='POST'&&u.pathname==='/api/companies'){const body=await readBody(req);let v={};try{v=JSON.parse(body||'{}')}catch(e){};const db=readJson(COMP_PATH);if(!v.code||!v.name||!v.currency||!v.tz)return send(res,400,JSON.stringify({error:'Missing required fields'}));if((db.rows||[]).some(c=>c.code===v.code))return send(res,400,JSON.stringify({error:'Company code exists'}));v.id=db.nextId++;v.subsidiaries=v.subsidiaries||[];db.rows.push(v);writeJson(COMP_PATH,db);return send(res,200,JSON.stringify(v))}
  if(req.method==='POST'&&u.pathname==='/api/subsidiaries'){const body=await readBody(req);let v={};try{v=JSON.parse(body||'{}')}catch(e){};const {parent,code,name,currency}=v;const db=readJson(COMP_PATH);const idx=(db.rows||[]).findIndex(c=>c.code===parent);if(idx<0)return send(res,404,JSON.stringify({error:'Parent not found'}));db.rows[idx].subsidiaries=db.rows[idx].subsidiaries||[];db.rows[idx].subsidiaries.push({code,name,currency});writeJson(COMP_PATH,db);return send(res,200,JSON.stringify({ok:true}))}

  if(req.method==='GET'&&u.pathname==='/api/accounts'){const db=readJson(ACC_PATH);let rows=db.rows||[];const {inactive,type}=u.query||{};if(inactive==='false')rows=rows.filter(a=>!a.inactive);if(type)rows=rows.filter(a=>a.type===type);return send(res,200,JSON.stringify(rows))}
  if(req.method==='POST'&&u.pathname==='/api/accounts'){const body=await readBody(req);let a={};try{a=JSON.parse(body||'{}')}catch(e){};const v=validateAccountNumber(a.type,a.code);if(!v.ok)return send(res,400,JSON.stringify({error:v.error}));const db=readJson(ACC_PATH);if((db.rows||[]).some(x=>x.code===a.code))return send(res,400,JSON.stringify({error:'Account code exists'}));a.internal_id=db.nextId++;db.rows.push(a);writeJson(ACC_PATH,db);return send(res,200,JSON.stringify(a))}
  if(req.method==='PUT'&&u.pathname.startsWith('/api/accounts/')){const idStr=u.pathname.split('/').pop();const id=parseInt(idStr,10);const body=await readBody(req);let a={};try{a=JSON.parse(body||'{}')}catch(e){};const v=validateAccountNumber(a.type,a.code);if(!v.ok)return send(res,400,JSON.stringify({error:v.error}));const db=readJson(ACC_PATH);const idx=(db.rows||[]).findIndex(x=>x.internal_id===id);if(idx<0)return send(res,404,JSON.stringify({error:'Not found'}));db.rows[idx]=Object.assign({},db.rows[idx],a,{internal_id:id});writeJson(ACC_PATH,db);return send(res,200,JSON.stringify(db.rows[idx]))}
  if(req.method==='POST'&&u.pathname==='/api/accounts/import-csv'){const text=await readBody(req);const lines=text.split(/\r?\n/).filter(l=>l.trim().length>0);let start=0;if(lines.length&&/number|name|type/i.test(lines[0]))start=1;const db=readJson(ACC_PATH);const errors=[];for(let i=start;i<lines.length;i++){const parts=lines[i].split(',').map(s=>s.trim());const [code,name,type,currency,summary,inactive,parent,subs] = [parts[0],parts[1],parts[2],parts[3],parts[4],parts[5],parts[6],parts[7]];const val=validateAccountNumber(type,code);if(!val.ok){errors.push({line:i+1,error:val.error});continue}if(db.rows.some(x=>x.code===code)){errors.push({line:i+1,error:'Duplicate code'});continue}const a={code,name,type,currency,summary:String(summary).toLowerCase()==='yes',inactive:String(inactive).toLowerCase()==='yes',parent:(parent||''),subsidiaries:(subs||'').split(';').map(s=>s.trim()).filter(Boolean),internal_id:db.nextId++};db.rows.push(a)}writeJson(ACC_PATH,db);return send(res,200,JSON.stringify({imported:db.rows.length,errors}))}

  if(req.method==='GET'&&u.pathname==='/api/items'){const db=readJson(ITEM_PATH);return send(res,200,JSON.stringify(db.rows||[]))}
  if(req.method==='POST'&&u.pathname==='/api/items'){const body=await readBody(req);let v={};try{v=JSON.parse(body||'{}')}catch(e){};const db=readJson(ITEM_PATH);if(!v.sku||!v.name)return send(res,400,JSON.stringify({error:'SKU and name required'}));if(db.rows.some(i=>i.sku===v.sku))return send(res,400,JSON.stringify({error:'SKU exists'}));v.id=db.nextId++;db.rows.push(v);writeJson(ITEM_PATH,db);return send(res,200,JSON.stringify(v))}
  if(req.method==='DELETE'&&u.pathname.startsWith('/api/items/')){const sku=decodeURIComponent(u.pathname.split('/').pop());const db=readJson(ITEM_PATH);db.rows=(db.rows||[]).filter(r=>r.sku!==sku);writeJson(ITEM_PATH,db);const detDb=readJson(ITEM_DETAIL_PATH);detDb.rows=(detDb.rows||[]).filter(r=>r.sku!==sku);writeJson(ITEM_DETAIL_PATH,detDb);return send(res,200,JSON.stringify({ok:true}))}
  if(req.method==='GET'&&u.pathname==='/api/items/details'){const db=readJson(ITEM_DETAIL_PATH);return send(res,200,JSON.stringify(db.rows||[]))}
  if(req.method==='POST'&&u.pathname==='/api/items/details'){const body=await readBody(req);let v={};try{v=JSON.parse(body||'{}')}catch(e){};if(!v.sku)return send(res,400,JSON.stringify({error:'SKU required'}));const db=readJson(ITEM_DETAIL_PATH);const idx=(db.rows||[]).findIndex(r=>r.sku===v.sku);if(idx>=0){db.rows[idx]=Object.assign({},db.rows[idx],v)}else{db.rows.push(v)}writeJson(ITEM_DETAIL_PATH,db);return send(res,200,JSON.stringify(v))}
  if(req.method==='POST'&&u.pathname==='/api/items/import-csv'){const text=await readBody(req);const lines=(text||'').split(/\r?\n/).filter(l=>l.trim().length>0);if(lines.length===0)return send(res,400,JSON.stringify({error:'Empty CSV'}));let start=0;const hdr=lines[0].toLowerCase();if(/sku|uom|asset|cogs|income/.test(hdr))start=1;const itemsDb=readJson(ITEM_PATH);const detDb=readJson(ITEM_DETAIL_PATH);const errors=[];let imported=0;for(let i=start;i<lines.length;i++){const parts=lines[i].split(',').map(s=>s.trim().replace(/^"|"$/g,''));const get=(idx)=>parts[idx]||'';const sku=get(0);const display=get(1);const type=get(2)||'Inventory';const uom=get(3);const asset_acc=get(4);const cogs_acc=get(5);const income_acc=get(6);const vendor=get(7);const purchase_price=Number(get(8)||0);const puom=get(9);const base_price=Number(get(10)||0);const tax=get(11);const suom=get(12);const costing=get(13)||'FIFO';const def_loc=get(14);const reorder=Number(get(15)||0);const min=Number(get(16)||0);const max=Number(get(17)||0);const weight=Number(get(18)||0);const dims=get(19);const def_bin=get(20);const dept=get(21);const klass=get(22);const class_loc=get(23);const subs=(get(24)||'').split(';').map(s=>s.trim()).filter(Boolean);const inactive=(get(25)||'No').toLowerCase()==='yes';if(!sku||!uom||!asset_acc||!cogs_acc||!income_acc){errors.push({line:i+1,error:'Missing mandatory fields (SKU,UOM,Asset/COGS/Income)'});continue}if(!itemsDb.rows.some(r=>r.sku===sku)){itemsDb.rows.push({id:itemsDb.nextId++,sku,name:display||sku,uom})}const idxDet=detDb.rows.findIndex(r=>r.sku===sku);const det={sku,display,type,uom,asset_acc,cogs_acc,income_acc,vendor,purchase_price,puom,base_price,tax,suom,costing,def_loc,reorder,min,max,weight,dims,def_bin,dept,class:klass,class_loc,subsidiaries:subs,inactive};if(idxDet>=0){detDb.rows[idxDet]=Object.assign({},detDb.rows[idxDet],det)}else{detDb.rows.push(det)}imported++;}writeJson(ITEM_PATH,itemsDb);writeJson(ITEM_DETAIL_PATH,detDb);return send(res,200,JSON.stringify({imported,errors}))}
  if(req.method==='DELETE'&&u.pathname.startsWith('/api/items/')){const sku=decodeURIComponent(u.pathname.split('/').pop());const db=readJson(ITEM_PATH);db.rows=(db.rows||[]).filter(r=>r.sku!==sku);writeJson(ITEM_PATH,db);const detDb=readJson(ITEM_DETAIL_PATH);detDb.rows=(detDb.rows||[]).filter(r=>r.sku!==sku);writeJson(ITEM_DETAIL_PATH,detDb);return send(res,200,JSON.stringify({ok:true}))}
  if(req.method==='GET'&&u.pathname==='/api/items/details'){const db=readJson(ITEM_DETAIL_PATH);return send(res,200,JSON.stringify(db.rows||[]))}
  if(req.method==='POST'&&u.pathname==='/api/items/details'){const body=await readBody(req);let v={};try{v=JSON.parse(body||'{}')}catch(e){};if(!v.sku)return send(res,400,JSON.stringify({error:'SKU required'}));const db=readJson(ITEM_DETAIL_PATH);const idx=(db.rows||[]).findIndex(r=>r.sku===v.sku);if(idx>=0){db.rows[idx]=Object.assign({},db.rows[idx],v)}else{db.rows.push(v)}writeJson(ITEM_DETAIL_PATH,db);return send(res,200,JSON.stringify(v))}
  if(req.method==='POST'&&u.pathname==='/api/items/import-csv'){const text=await readBody(req);const lines=(text||'').split(/\r?\n/).filter(l=>l.trim().length>0);if(lines.length===0)return send(res,400,JSON.stringify({error:'Empty CSV'}));let start=0;const hdr=lines[0].toLowerCase();if(/sku|uom|asset|cogs|income/.test(hdr))start=1;const itemsDb=readJson(ITEM_PATH);const detDb=readJson(ITEM_DETAIL_PATH);const errors=[];let imported=0;for(let i=start;i<lines.length;i++){const parts=lines[i].split(',').map(s=>s.trim().replace(/^"|"$/g,''));const get=(idx)=>parts[idx]||'';const sku=get(0);const display=get(1);const type=get(2)||'Inventory';const uom=get(3);const asset_acc=get(4);const cogs_acc=get(5);const income_acc=get(6);const vendor=get(7);const purchase_price=Number(get(8)||0);const puom=get(9);const base_price=Number(get(10)||0);const tax=get(11);const suom=get(12);const costing=get(13)||'FIFO';const def_loc=get(14);const reorder=Number(get(15)||0);const min=Number(get(16)||0);const max=Number(get(17)||0);const weight=Number(get(18)||0);const dims=get(19);const def_bin=get(20);const dept=get(21);const klass=get(22);const class_loc=get(23);const subs=(get(24)||'').split(';').map(s=>s.trim()).filter(Boolean);const inactive=(get(25)||'No').toLowerCase()==='yes';if(!sku||!uom||!asset_acc||!cogs_acc||!income_acc){errors.push({line:i+1,error:'Missing mandatory fields (SKU,UOM,Asset/COGS/Income)'});continue}if(!itemsDb.rows.some(r=>r.sku===sku)){itemsDb.rows.push({id:itemsDb.nextId++,sku,name:display||sku,uom})}const idxDet=detDb.rows.findIndex(r=>r.sku===sku);const det={sku,display,type,uom,asset_acc,cogs_acc,income_acc,vendor,purchase_price,puom,base_price,tax,suom,costing,def_loc,reorder,min,max,weight,dims,def_bin,dept,class:klass,class_loc,subsidiaries:subs,inactive};if(idxDet>=0){detDb.rows[idxDet]=Object.assign({},detDb.rows[idxDet],det)}else{detDb.rows.push(det)}imported++;}writeJson(ITEM_PATH,itemsDb);writeJson(ITEM_DETAIL_PATH,detDb);return send(res,200,JSON.stringify({imported,errors}))}
  if(req.method==='GET'&&u.pathname==='/api/items/details'){const db=readJson(ITEM_DETAIL_PATH);return send(res,200,JSON.stringify(db.rows||[]))}
  if(req.method==='POST'&&u.pathname==='/api/items/details'){const body=await readBody(req);let v={};try{v=JSON.parse(body||'{}')}catch(e){};if(!v.sku)return send(res,400,JSON.stringify({error:'SKU required'}));const db=readJson(ITEM_DETAIL_PATH);const idx=(db.rows||[]).findIndex(r=>r.sku===v.sku);if(idx>=0){db.rows[idx]=Object.assign({},db.rows[idx],v)}else{db.rows.push(v)}writeJson(ITEM_DETAIL_PATH,db);return send(res,200,JSON.stringify(v))}

  // Locations
  if(req.method==='GET'&&u.pathname==='/api/locations'){const db=readJson(LOC_PATH);let rows=db.rows||[];const {company_code}=u.query||{};if(company_code)rows=rows.filter(r=>r.company_code===company_code);return send(res,200,JSON.stringify(rows))}
  if(req.method==='POST'&&u.pathname==='/api/locations'){const body=await readBody(req);let v={};try{v=JSON.parse(body||'{}')}catch(e){};const {company_code,location_code,name}=v;if(!company_code||!location_code||!name)return send(res,400,JSON.stringify({error:'Missing fields'}));const db=readJson(LOC_PATH);if(db.rows.some(r=>r.company_code===company_code&&r.location_code===location_code))return send(res,400,JSON.stringify({error:'Location exists'}));const row={id:db.nextId++,company_code,location_code,name};db.rows.push(row);writeJson(LOC_PATH,db);return send(res,200,JSON.stringify(row))}
  if(req.method==='DELETE'&&u.pathname.startsWith('/api/locations/')){const id=parseInt(u.pathname.split('/').pop(),10);const db=readJson(LOC_PATH);db.rows=(db.rows||[]).filter(r=>r.id!==id);writeJson(LOC_PATH,db);return send(res,200,JSON.stringify({ok:true}))}

  // Bins
  if(req.method==='GET'&&u.pathname==='/api/bins'){const db=readJson(BIN_PATH);let rows=db.rows||[];const {company_code,location_code}=u.query||{};if(company_code)rows=rows.filter(r=>r.company_code===company_code);if(location_code)rows=rows.filter(r=>r.location_code===location_code);return send(res,200,JSON.stringify(rows))}
  if(req.method==='POST'&&u.pathname==='/api/bins'){const body=await readBody(req);let v={};try{v=JSON.parse(body||'{}')}catch(e){};const {company_code,location_code,bin_code,name}=v;if(!company_code||!location_code||!bin_code||!name)return send(res,400,JSON.stringify({error:'Missing fields'}));const db=readJson(BIN_PATH);if(db.rows.some(r=>r.company_code===company_code&&r.location_code===location_code&&r.bin_code===bin_code))return send(res,400,JSON.stringify({error:'Bin exists'}));const row={id:db.nextId++,company_code,location_code,bin_code,name};db.rows.push(row);writeJson(BIN_PATH,db);return send(res,200,JSON.stringify(row))}
  if(req.method==='DELETE'&&u.pathname.startsWith('/api/bins/')){const id=parseInt(u.pathname.split('/').pop(),10);const db=readJson(BIN_PATH);db.rows=(db.rows||[]).filter(r=>r.id!==id);writeJson(BIN_PATH,db);return send(res,200,JSON.stringify({ok:true}))}

  if(req.method==='POST'&&u.pathname==='/api/inventory/movements'){const body=await readBody(req);let v={};try{v=JSON.parse(body||'{}')}catch(e){};const {company_code,location,item_sku,qty,direction,reason,reference,bin_code,idempotency_key}=v;const q=Number(qty||0);if(!company_code||!item_sku||!location||!q||!(direction==='in'||direction==='out'))return send(res,400,JSON.stringify({error:'Invalid movement'}));const invDb=readJson(INV_PATH);if(idempotency_key&&invDb.rows.some(r=>r.idempotency_key===idempotency_key))return send(res,200,JSON.stringify({ok:true,duplicate:true}));const compositeLoc=location+(bin_code?(':'+bin_code):'');
    // Update qty and average cost
    const detDb=readJson(ITEM_DETAIL_PATH);const det=(detDb.rows||[]).find(d=>d.sku===item_sku)||{};
    const idx=invDb.rows.findIndex(r=>r.company_code===company_code&&r.location===compositeLoc&&r.item_sku===item_sku);
    let row=idx>=0?invDb.rows[idx]:{company_code,location:compositeLoc,item_sku,qty_on_hand:0,avg_cost:0};
    if(direction==='in'){
      const inCost=Number(det.purchase_price||det.base_price||row.avg_cost||0);
      const prevQty=Number(row.qty_on_hand||0);
      const newQty=prevQty+q;
      row.avg_cost = newQty>0 ? (prevQty*Number(row.avg_cost||0)+q*inCost)/newQty : inCost;
      row.qty_on_hand=newQty;
    }else{
      row.qty_on_hand = Number(row.qty_on_hand||0) - q; if(row.qty_on_hand<0) row.qty_on_hand=0;
    }
    if(idx>=0)invDb.rows[idx]=row;else invDb.rows.push(row); writeJson(INV_PATH,invDb);
    // Valuation GL
    let lines=[];const unitCost = direction==='in' ? Number(det.purchase_price||det.base_price||row.avg_cost||0) : Number(row.avg_cost||det.purchase_price||0); const amt = unitCost*q;
    if((det.type||'Inventory')==='Inventory' && amt>0){
      if(direction==='in'){
        lines=[{account_code:String(det.asset_acc||''),debit:amt,credit:0,desc:(reason||'Receipt')},{account_code:String('2200'),debit:0,credit:amt,desc:(reference||'GRNI')}] // AP Clearing default 2200
      } else {
        lines=[{account_code:String(det.cogs_acc||''),debit:amt,credit:0,desc:(reason||'Issue')},{account_code:String(det.asset_acc||''),debit:0,credit:amt,desc:(reference||'Inventory')}]
      }
      // Validate debits=credits and summary accounts
      const bal=lines.reduce((a,b)=>({debit:a.debit+b.debit,credit:a.credit+b.credit}),{debit:0,credit:0}); if(Math.abs(bal.debit-bal.credit)>0.0001) return send(res,400,JSON.stringify({error:'Debits must equal credits'})); const chk=preventSummaryPosting(lines); if(!chk.ok) return send(res,400,JSON.stringify({error:chk.error})); if(!isPeriodOpen(company_code,new Date().toISOString().slice(0,10))) return send(res,400,JSON.stringify({error:'Period is closed'})); const glDb=readJson(GL_PATH); if(idempotency_key){const dup=glDb.rows.find(r=>r.company_code===company_code&&r.idempotency_key===idempotency_key); if(dup) return send(res,200,JSON.stringify({balance:row,gl_number:dup.gl_number}))} const gl_number=getSeries(company_code,'GL'); const entry={id:glDb.nextId++,gl_number,company_code,date:new Date().toISOString().slice(0,10),lines,reference,status:'posted',idempotency_key:idempotency_key||null}; glDb.rows.push(entry); writeJson(GL_PATH,glDb);
      return send(res,200,JSON.stringify({balance:row,gl_number}))
    }
    return send(res,200,JSON.stringify({balance:row}))}
  if(req.method==='GET'&&u.pathname==='/api/inventory/balances'){const db=readJson(INV_PATH);let rows=db.rows||[];const {company_code,item_sku}=u.query||{};if(company_code)rows=rows.filter(r=>r.company_code===company_code);if(item_sku)rows=rows.filter(r=>r.item_sku===item_sku);return send(res,200,JSON.stringify(rows))}
  // Transfer (no GL within same company)
  if(req.method==='POST'&&u.pathname==='/api/inventory/transfer'){const body=await readBody(req);let v={};try{v=JSON.parse(body||'{}')}catch(e){};const {company_code,from_location,from_bin,to_location,to_bin,item_sku,qty,idempotency_key,to_company_code}=v;const q=Number(qty||0);if(!company_code||!from_location||!to_location||!item_sku||q<=0)return send(res,400,JSON.stringify({error:'Invalid transfer'}));const fromLoc=from_location+(from_bin?(':'+from_bin):'');const toLoc=to_location+(to_bin?(':'+to_bin):'');const invDb=readJson(INV_PATH);const idxFrom=invDb.rows.findIndex(r=>r.company_code===company_code&&r.location===fromLoc&&r.item_sku===item_sku);if(idxFrom<0||Number(invDb.rows[idxFrom].qty_on_hand||0)<q)return send(res,400,JSON.stringify({error:'Insufficient qty'}));const fromRow=invDb.rows[idxFrom];fromRow.qty_on_hand=Number(fromRow.qty_on_hand||0)-q;invDb.rows[idxFrom]=fromRow;const idxTo=invDb.rows.findIndex(r=>r.company_code===(to_company_code||company_code)&&r.location===toLoc&&r.item_sku===item_sku);let toRow=idxTo>=0?invDb.rows[idxTo]:{company_code:(to_company_code||company_code),location:toLoc,item_sku,qty_on_hand:0,avg_cost:fromRow.avg_cost||0};const prevQty=Number(toRow.qty_on_hand||0);const newQty=prevQty+q;toRow.avg_cost = newQty>0 ? (prevQty*Number(toRow.avg_cost||0)+q*Number(fromRow.avg_cost||0))/newQty : Number(fromRow.avg_cost||0);toRow.qty_on_hand=newQty;if(idxTo>=0)invDb.rows[idxTo]=toRow;else invDb.rows.push(toRow);writeJson(INV_PATH,invDb);
    // Intercompany GL: debit asset in to company, credit asset in from company
    if((to_company_code||company_code)!==company_code){const detDb=readJson(ITEM_DETAIL_PATH);const det=(detDb.rows||[]).find(d=>d.sku===item_sku)||{};const amt=Number(fromRow.avg_cost||0)*q; if(amt>0){const linesFrom=[{account_code:String(det.asset_acc||''),debit:0,credit:amt,desc:'Transfer out'}]; const linesTo=[{account_code:String(det.asset_acc||''),debit:amt,credit:0,desc:'Transfer in'}]; const glDb=readJson(GL_PATH); const glFrom=getSeries(company_code,'GL'); glDb.rows.push({id:glDb.nextId++,gl_number:glFrom,company_code,date:new Date().toISOString().slice(0,10),lines:linesFrom,reference:'Intercompany transfer',status:'posted'}); const glTo=getSeries((to_company_code||company_code),'GL'); glDb.rows.push({id:glDb.nextId++,gl_number:glTo,company_code:(to_company_code||company_code),date:new Date().toISOString().slice(0,10),lines:linesTo,reference:'Intercompany transfer',status:'posted'}); writeJson(GL_PATH,glDb); return send(res,200,JSON.stringify({from:fromRow,to:toRow,gl_from:glFrom,gl_to:glTo}))}
    }
    return send(res,200,JSON.stringify({from:fromRow,to:toRow}))}
  // Adjustment (GL -> Inventory Adjustment account, default 5700)
  if(req.method==='POST'&&u.pathname==='/api/inventory/adjustment'){const body=await readBody(req);let v={};try{v=JSON.parse(body||'{}')}catch(e){};const {company_code,location,bin_code,item_sku,qty,reason,reference,adjustment_account,idempotency_key}=v;const q=Number(qty||0);if(!company_code||!location||!item_sku||q===0)return send(res,400,JSON.stringify({error:'Invalid adjustment'}));const invDb=readJson(INV_PATH);const compositeLoc=location+(bin_code?(':'+bin_code):'');const idx=invDb.rows.findIndex(r=>r.company_code===company_code&&r.location===compositeLoc&&r.item_sku===item_sku);let row=idx>=0?invDb.rows[idx]:{company_code,location:compositeLoc,item_sku,qty_on_hand:0,avg_cost:0};const detDb=readJson(ITEM_DETAIL_PATH);const det=(detDb.rows||[]).find(d=>d.sku===item_sku)||{};const unitCost=Number(row.avg_cost||det.purchase_price||det.base_price||0);row.qty_on_hand=Number(row.qty_on_hand||0)+q;if(row.qty_on_hand<0)row.qty_on_hand=0;if(idx>=0)invDb.rows[idx]=row;else invDb.rows.push(row);writeJson(INV_PATH,invDb);const amt=Math.abs(unitCost*q);const adjAcc=String(adjustment_account||'5700');let lines;if(q>0){lines=[{account_code:String(det.asset_acc||''),debit:amt,credit:0,desc:(reason||'Adj +')},{account_code:adjAcc,debit:0,credit:amt,desc:(reference||'Inventory Adj')}] } else {lines=[{account_code:adjAcc,debit:amt,credit:0,desc:(reason||'Adj -')},{account_code:String(det.asset_acc||''),debit:0,credit:amt,desc:(reference||'Inventory Adj')}] } const bal=lines.reduce((a,b)=>({debit:a.debit+b.debit,credit:a.credit+b.credit}),{debit:0,credit:0}); if(Math.abs(bal.debit-bal.credit)>0.0001) return send(res,400,JSON.stringify({error:'Debits must equal credits'})); const chk=preventSummaryPosting(lines); if(!chk.ok) return send(res,400,JSON.stringify({error:chk.error})); if(!isPeriodOpen(company_code,new Date().toISOString().slice(0,10))) return send(res,400,JSON.stringify({error:'Period is closed'})); const glDb=readJson(GL_PATH); if(idempotency_key){const dup=glDb.rows.find(r=>r.company_code===company_code&&r.idempotency_key===idempotency_key); if(dup) return send(res,200,JSON.stringify({balance:row,gl_number:dup.gl_number}))} const gl_number=getSeries(company_code,'GL'); const entry={id:glDb.nextId++,gl_number,company_code,date:new Date().toISOString().slice(0,10),lines,reference,status:'posted',idempotency_key:idempotency_key||null}; glDb.rows.push(entry); writeJson(GL_PATH,glDb); return send(res,200,JSON.stringify({balance:row,gl_number}))}

  if(req.method==='POST'&&u.pathname==='/api/gl/post'){const body=await readBody(req);let v={};try{v=JSON.parse(body||'{}')}catch(e){};const {company_code,date,lines,reference,idempotency_key}=v;const l=(Array.isArray(lines)?lines:[]).map(x=>({account_code:String(x.account_code||''),debit:Number(x.debit||0),credit:Number(x.credit||0),desc:String(x.desc||'')}));if(!company_code||l.length===0)return send(res,400,JSON.stringify({error:'Missing company or lines'}));if(!isPeriodOpen(company_code,date||new Date().toISOString().slice(0,10)))return send(res,400,JSON.stringify({error:'Period is closed'}));const glDb=readJson(GL_PATH);if(idempotency_key){const dup=glDb.rows.find(r=>r.company_code===company_code&&r.idempotency_key===idempotency_key);if(dup)return send(res,200,JSON.stringify(dup))}const bal=l.reduce((a,b)=>({debit:a.debit+b.debit,credit:a.credit+b.credit}),{debit:0,credit:0});if(Math.abs(bal.debit-bal.credit)>0.0001)return send(res,400,JSON.stringify({error:'Debits must equal credits'}));const chk=preventSummaryPosting(l);if(!chk.ok)return send(res,400,JSON.stringify({error:chk.error}));const gl_number=getSeries(company_code,'GL');const entry={id:glDb.nextId++,gl_number,company_code,date:date||new Date().toISOString().slice(0,10),lines:l,reference,status:'posted',idempotency_key:idempotency_key||null};glDb.rows.push(entry);writeJson(GL_PATH,glDb);return send(res,200,JSON.stringify(entry))}
  if(req.method==='GET'&&u.pathname==='/api/gl/entries'){const db=readJson(GL_PATH);let rows=db.rows||[];const {company_code}=u.query||{};if(company_code)rows=rows.filter(r=>r.company_code===company_code);return send(res,200,JSON.stringify(rows))}

  // Period status
  if(req.method==='GET'&&u.pathname==='/api/periods'){const db=readJson(PER_PATH);let rows=db.rows||[];const {company_code}=u.query||{};if(company_code)rows=rows.filter(r=>r.company_code===company_code);return send(res,200,JSON.stringify(rows))}
  if(req.method==='PUT'&&u.pathname==='/api/periods'){const body=await readBody(req);let v={};try{v=JSON.parse(body||'{}')}catch(e){};const {company_code,date,status}=v;if(!company_code||!date||!status)return send(res,400,JSON.stringify({error:'Missing fields'}));const key=periodKey(date);const db=readJson(PER_PATH);const idx=(db.rows||[]).findIndex(r=>r.company_code===company_code&&r.key===key);const row={company_code,key,status};if(idx>=0)db.rows[idx]=row;else db.rows.push(row);writeJson(PER_PATH,db);return send(res,200,JSON.stringify(row))}

  // AP/AR series
  if(req.method==='POST'&&u.pathname==='/api/ap/bills'){const body=await readBody(req);let v={};try{v=JSON.parse(body||'{}')}catch(e){};const {company_code,vendor,amount}=v;if(!company_code||!vendor||!Number(amount))return send(res,400,JSON.stringify({error:'Missing fields'}));const bill_number=getSeries(company_code,'APBILL');return send(res,200,JSON.stringify({bill_number,company_code,vendor,amount}))}
  if(req.method==='POST'&&u.pathname==='/api/ar/invoices'){const body=await readBody(req);let v={};try{v=JSON.parse(body||'{}')}catch(e){};const {company_code,customer,amount}=v;if(!company_code||!customer||!Number(amount))return send(res,400,JSON.stringify({error:'Missing fields'}));const inv_number=getSeries(company_code,'ARINV');return send(res,200,JSON.stringify({inv_number,company_code,customer,amount}))}

  if(req.method==='POST'&&u.pathname==='/api/ap/ocr'){const body=await readBody(req);let text=body||'';const lines=text.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);const vendor=lines.find(s=>/^vendor:/i.test(s));const total=lines.find(s=>/^total:/i.test(s));const date=lines.find(s=>/^date:/i.test(s));const out={vendor:vendor?vendor.split(':')[1].trim():'',total:total?Number(total.split(':')[1].trim()||0):0,date:date?date.split(':')[1].trim():'',items:[]};for(const s of lines){const m=s.match(/^item\s*,\s*(.+?)\s*,\s*(\d+(?:\.\d+)?)\s*,\s*(\d+(?:\.\d+)?)$/i);if(m)out.items.push({sku:m[1],qty:Number(m[2]),price:Number(m[3])})}return send(res,200,JSON.stringify(out))}
  if(req.method==='GET'&&u.pathname==='/config/rates'){const cfg=readCfg();return send(res,200,JSON.stringify(cfg));}
  if(req.method==='PUT'&&u.pathname==='/config/rates'){const body=await readBody(req);let cfg;try{cfg=JSON.parse(body||'{}');}catch(e){cfg=readCfg();}writeCfg(cfg);return send(res,200,JSON.stringify(cfg));}
  if(req.method==='POST'&&u.pathname==='/config/rates/import-csv'){const text=await readBody(req);const rows=parseCSV(text||'');const cfg=readCfg();cfg.area_overrides=cfg.area_overrides||{};rows.forEach(r=>{const key=(r.country+'/'+r.region+'/'+r.district).toLowerCase();cfg.area_overrides[key]={country:r.country,region:r.region,district:r.district,active:r.active};if(typeof r.threshold_hkd==='number')cfg.area_overrides[key].threshold_hkd=r.threshold_hkd; if(typeof r.fee_hkd==='number')cfg.area_overrides[key].fee_hkd=r.fee_hkd;});writeCfg(cfg);return send(res,200,JSON.stringify(cfg));}
  if(req.method==='GET'&&u.pathname==='/hk/districts'){return send(res,200,JSON.stringify(getDistricts()));}
  // AI command parser
  if(req.method==='POST'&&u.pathname==='/api/ai/command'){const body=await readBody(req);let v={};try{v=JSON.parse(body||'{}')}catch(e){};const text=String(v.text||'');const out={action:'parse',ok:false};const get=(key)=>{const m=text.match(new RegExp(key+'\s+([\w\-\.]+)','i'));return m?m[1]:''};try{
      if(/create\s+item/i.test(text)){const sku=get('item');const name=(text.match(/name\s+([^,\n]+)/i)||[])[1]||sku;const uom=get('uom');const asset=get('asset');const cogs=get('cogs');const income=get('income');if(!sku||!uom){out.error='SKU and UOM required';return send(res,400,JSON.stringify(out))}const base={sku,name,uom};const det={sku,display:name,uom,asset_acc:asset,cogs_acc:cogs,income_acc:income,type:'Inventory'};const itemsDb=readJson(ITEM_PATH);if(!itemsDb.rows.some(r=>r.sku===sku)){itemsDb.rows.push({id:itemsDb.nextId++,...base});writeJson(ITEM_PATH,itemsDb)}const detDb=readJson(ITEM_DETAIL_PATH);const idx=detDb.rows.findIndex(r=>r.sku===sku);if(idx>=0)detDb.rows[idx]=Object.assign({},detDb.rows[idx],det);else detDb.rows.push(det);writeJson(ITEM_DETAIL_PATH,detDb);out.action='create item';out.ok=true;out.details=sku;return send(res,200,JSON.stringify(out))}
      if(/record\s+receipt/i.test(text)||/receive\s+/i.test(text)){const company=get('company');const location=get('location');const sku=get('sku');const qtyStr=(text.match(/qty\s+(\d+(?:\.\d+)?)/i)||[])[1];const qty=Number(qtyStr||0);if(!company||!location||!sku||qty<=0){out.error='Missing company/location/sku/qty';return send(res,400,JSON.stringify(out))}const r=await (async()=>{const invDb=readJson(INV_PATH);const detDb=readJson(ITEM_DETAIL_PATH);const det=(detDb.rows||[]).find(d=>d.sku===sku)||{};const compositeLoc=location;const idx=invDb.rows.findIndex(r=>r.company_code===company&&r.location===compositeLoc&&r.item_sku===sku);let row=idx>=0?invDb.rows[idx]:{company_code:company,location:compositeLoc,item_sku:sku,qty_on_hand:0,avg_cost:0};const inCost=Number(det.purchase_price||det.base_price||row.avg_cost||0);const prevQty=Number(row.qty_on_hand||0);const newQty=prevQty+qty;row.avg_cost = newQty>0 ? (prevQty*Number(row.avg_cost||0)+qty*inCost)/newQty : inCost;row.qty_on_hand=newQty;if(idx>=0)invDb.rows[idx]=row;else invDb.rows.push(row);writeJson(INV_PATH,invDb);return row})();out.action='receipt';out.ok=true;out.details=`${sku} x ${qty} to ${location}`;return send(res,200,JSON.stringify(out))}
      if(/record\s+issue/i.test(text)||/issue\s+/i.test(text)){const company=get('company');const location=get('location');const sku=get('sku');const qtyStr=(text.match(/qty\s+(\d+(?:\.\d+)?)/i)||[])[1];const qty=Number(qtyStr||0);if(!company||!location||!sku||qty<=0){out.error='Missing company/location/sku/qty';return send(res,400,JSON.stringify(out))}const invDb=readJson(INV_PATH);const idx=invDb.rows.findIndex(r=>r.company_code===company&&r.location===location&&r.item_sku===sku);if(idx<0)return send(res,400,JSON.stringify({action:'issue',ok:false,error:'No stock'}));invDb.rows[idx].qty_on_hand=Number(invDb.rows[idx].qty_on_hand||0)-qty;if(invDb.rows[idx].qty_on_hand<0)invDb.rows[idx].qty_on_hand=0;writeJson(INV_PATH,invDb);return send(res,200,JSON.stringify({action:'issue',ok:true,details:`${sku} x ${qty} from ${location}`}))}
      if(/close\s+period/i.test(text)){const company=get('company');const period=(text.match(/period\s+(\d{4}-\d{2})/i)||[])[1];if(!company||!period)return send(res,400,JSON.stringify({action:'close period',ok:false,error:'Missing company/period'}));const db=readJson(PER_PATH);const row={company_code:company,key:period,status:'closed'};const idx=(db.rows||[]).findIndex(r=>r.company_code===company&&r.key===period);if(idx>=0)db.rows[idx]=row;else db.rows.push(row);writeJson(PER_PATH,db);return send(res,200,JSON.stringify({action:'close period',ok:true,details:period}))}
      out.error='No matching command';return send(res,400,JSON.stringify(out));
  }catch(e){return send(res,500,JSON.stringify({action:'parse',ok:false,error:String(e)}))}}
  // Advanced movement with FIFO and GL
  if(req.method==='POST'&&u.pathname==='/api/inventory/move'){const body=await readBody(req);let v={};try{v=JSON.parse(body||'{}')}catch(e){};const {company_code,location,item_sku,qty,direction,reason,reference,bin_code,idempotency_key}=v;const q=Number(qty||0);if(!company_code||!item_sku||!location||!q||!(direction==='in'||direction==='out'))return send(res,400,JSON.stringify({error:'Invalid movement'}));const invDb=readJson(INV_PATH);const detDb=readJson(ITEM_DETAIL_PATH);const det=(detDb.rows||[]).find(d=>d.sku===item_sku)||{};const compositeLoc=location+(bin_code?(':'+bin_code):'');const idx=invDb.rows.findIndex(r=>r.company_code===company_code&&r.location===compositeLoc&&r.item_sku===item_sku);let row=idx>=0?invDb.rows[idx]:{company_code,location:compositeLoc,item_sku,qty_on_hand:0,avg_cost:0};let amt=0;let unitCost=0; if(direction==='in'){unitCost=Number(det.purchase_price||det.base_price||row.avg_cost||0);const prevQty=Number(row.qty_on_hand||0);const newQty=prevQty+q;row.avg_cost = newQty>0 ? (prevQty*Number(row.avg_cost||0)+q*unitCost)/newQty : unitCost;row.qty_on_hand=newQty; if((det.costing||'FIFO')==='FIFO'){const layers=fifoGet(company_code,compositeLoc,item_sku);layers.push({qty:q,cost:unitCost,received_at:new Date().toISOString()});fifoSet(company_code,compositeLoc,item_sku,layers)} amt=unitCost*q; } else { let layersCost=0;if((det.costing||'FIFO')==='FIFO'){let remaining=q;const layers=fifoGet(company_code,compositeLoc,item_sku);while(remaining>0 && layers.length>0){const layer=layers[0];const take=Math.min(remaining,layer.qty);layersCost+=take*Number(layer.cost||0);layer.qty-=take;remaining-=take;if(layer.qty<=0)layers.shift()}fifoSet(company_code,compositeLoc,item_sku,layers)} unitCost=Number(row.avg_cost||det.purchase_price||det.base_price||0);amt=layersCost>0?layersCost:unitCost*q; row.qty_on_hand = Number(row.qty_on_hand||0) - q; if(row.qty_on_hand<0) row.qty_on_hand=0;} if(idx>=0)invDb.rows[idx]=row;else invDb.rows.push(row); writeJson(INV_PATH,invDb); let lines=[]; if((det.type||'Inventory')==='Inventory' && amt>0){ if(direction==='in'){lines=[{account_code:String(det.asset_acc||''),debit:amt,credit:0,desc:(reason||'Receipt')},{account_code:String('2200'),debit:0,credit:amt,desc:(reference||'GRNI')}] } else {lines=[{account_code:String(det.cogs_acc||''),debit:amt,credit:0,desc:(reason||'Issue')},{account_code:String(det.asset_acc||''),debit:0,credit:amt,desc:(reference||'Inventory')}]} const bal=lines.reduce((a,b)=>({debit:a.debit+b.debit,credit:a.credit+b.credit}),{debit:0,credit:0}); if(Math.abs(bal.debit-bal.credit)>0.0001) return send(res,400,JSON.stringify({error:'Debits must equal credits'})); const chk=preventSummaryPosting(lines); if(!chk.ok) return send(res,400,JSON.stringify({error:chk.error})); if(!isPeriodOpen(company_code,new Date().toISOString().slice(0,10))) return send(res,400,JSON.stringify({error:'Period is closed'})); const glDb=readJson(GL_PATH); const gl_number=getSeries(company_code,'GL'); const entry={id:glDb.nextId++,gl_number,company_code,date:new Date().toISOString().slice(0,10),lines,reference,status:'posted',idempotency_key:idempotency_key||null}; glDb.rows.push(entry); writeJson(GL_PATH,glDb); return send(res,200,JSON.stringify({balance:row,gl_number})) } 
  if(req.method==='GET'&&u.pathname==='/spec'){try{const p=path.join(ROOT,'VKS Shipping Rate apps User Requirement.xml');const data=fs.readFileSync(p,'utf8');const msg=(data.slice(0,2048)||'');return send(res,200,JSON.stringify({text:msg}));}catch(e){return send(res,200,JSON.stringify({text:'Open the XML via the link on the right panel.'}));}}
  if(req.method==='POST'&&u.pathname==='/carrier/rates'){const body=await readBody(req);let json={};try{json=JSON.parse(body||'{}');}catch(e){}const cfg=readCfg();const out=calcRates(cfg,json);return send(res,200,JSON.stringify(out));}
  return serveStatic(req,res,u.pathname);
});

server.listen(PORT,()=>{console.log('listening on http://localhost:'+PORT+'/');});
function getSeries(company_code,entity){let ser;try{ser=JSON.parse(fs.readFileSync(SER_PATH,'utf8'))}catch(e){ser={}}ser[company_code]=ser[company_code]||{};ser[company_code][entity]=ser[company_code][entity]||{prefix:entity+'-'+company_code+'-',current:1,width:5,reset_policy:'year',last_reset_at:new Date().toISOString().slice(0,10)};const s=ser[company_code][entity];const y=new Date().getFullYear().toString();const num=String(s.current).padStart(s.width||5,'0');const final=s.prefix+y+'-'+num; s.current++;fs.writeFileSync(SER_PATH,JSON.stringify(ser,null,2),'utf8');return final}
function updateInventory(company_code,location,item_sku,qty,direction){const db=readJson(INV_PATH);db.rows=db.rows||[];const key={company_code,location,item_sku};const idx=db.rows.findIndex(r=>r.company_code===company_code&&r.location===location&&r.item_sku===item_sku);let row=idx>=0?db.rows[idx]:Object.assign({qty_on_hand:0},key);row.qty_on_hand = (row.qty_on_hand||0) + (direction==='in'?qty:-qty);if(idx>=0)db.rows[idx]=row;else db.rows.push(row);writeJson(INV_PATH,db);return row}
function preventSummaryPosting(lines){const accDb=readJson(ACC_PATH);const byCode=new Map((accDb.rows||[]).map(a=>[a.code,a]));for(const ln of lines){const acc=byCode.get(String(ln.account_code));if(acc&&acc.summary){return {ok:false,error:'Summary account cannot be posted: '+acc.code}}}return {ok:true}}
