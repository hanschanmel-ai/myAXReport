<!doctype html>
<html>
<head>
  <meta charset="utf-8"><title>Purchase Orders</title>
  <link href="/erp/ns-main.css" rel="stylesheet">
  <style>body{font-family:system-ui,Segoe UI,Arial;margin:24px}input,button,textarea{padding:8px;border:1px solid #e5e7eb;border-radius:6px}button{background:#1558b0;color:#fff;border:none} .row{display:flex;gap:8px;margin:8px 0} table{border-collapse:collapse;width:100%}th,td{border:1px solid #e5e7eb;padding:8px;text-align:left}th{background:#f3f4f6}</style>
</head>
<body>
  
  <h2>Create PO</h2>
  <div class="row">
    <input id="company" placeholder="company_code" value="ACME">
    <input id="vendor" placeholder="vendor" value="VEND1">
  </div>
  <div>
    Lines (sku,qty,price per line):
    <textarea id="lines" rows="4" cols="60">ITEM1,10,12
ITEM2,5,8</textarea>
  </div>
  <div class="row"><button id="create">Create PO</button><span id="po_out"></span></div>

  <h2>PO List</h2>
  <div class="row"><button id="list">Refresh List</button></div>
  <table>
    <thead><tr><th>PO#</th><th>Vendor</th><th>Status</th><th>Date</th><th>Lines</th></tr></thead>
    <tbody id="po_rows"></tbody>
  </table>

  <h2>Receive PO</h2>
  <div class="row">
    <input id="po_number" placeholder="po_number">
    <input id="recv_loc" placeholder="location" value="MAIN">
    <button id="receive">Receive</button>
  </div>
  <div id="recv_out"></div>

  <script>
    const APIS=['http://127.0.0.1:8788',''];
    async function api(path,opts){for(const base of APIS){try{const r=await fetch((base||'')+path,opts);if(!r.ok)throw new Error('HTTP '+r.status);return await r.json()}catch(e){if(base===APIS[APIS.length-1])throw e}}return []}
    function headers(){const t=localStorage.getItem('token');const h={'Content-Type':'application/json'};if(t)h['Authorization']='Bearer '+t;return h}
    function parseLines(text){return text.split(/\r?\n/).filter(Boolean).map(l=>{const [sku,qty,price]=l.split(',').map(s=>s.trim());return {sku,qty:Number(qty||0),price:Number(price||0)}})}
    async function create(){const body={company_code:val('company'),vendor:val('vendor'),lines:parseLines(val('lines'))};const j=await api('/api/purchase/orders',{method:'POST',headers:headers(),body:JSON.stringify(body)});if(j.error)alert(j.error);else{document.getElementById('po_out').textContent='PO: '+j.po_number;await list()}}
    async function receive(){const po_number=val('po_number');const body={company_code:val('company'),po_number,location:val('recv_loc')};const j=await api('/api/purchase/receive',{method:'POST',headers:headers(),body:JSON.stringify(body)});if(j.error)alert(j.error);else{document.getElementById('recv_out').textContent='Received '+(j.po_number||po_number)+', GL '+(j.gl_number||'');await list()}}
    async function list(){const arr=await api('/api/purchase/orders');const tb=document.getElementById('po_rows');tb.innerHTML='';arr.forEach(o=>{const lines=(o.lines||[]).length;const tr=document.createElement('tr');tr.innerHTML=`<td><a href=\"#\" data-po=\"${o.po_number||''}\">${o.po_number||''}</a></td><td>${o.vendor||''}</td><td>${o.status||''}</td><td>${o.date||''}</td><td>${lines}</td>`;tb.appendChild(tr)});Array.from(tb.querySelectorAll('a[data-po]')).forEach(a=>a.onclick=function(){document.getElementById('po_number').value=this.getAttribute('data-po')})}
    function val(id){return document.getElementById(id).value}
    document.getElementById('create').onclick=create
    document.getElementById('receive').onclick=receive
    document.getElementById('list').onclick=list
    list()
  </script>
</body>
</html>
