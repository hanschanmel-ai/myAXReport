const http=require('node:http');
const fs=require('node:fs');
const path=require('node:path');
const { parse: parseUrl } = require('node:url');

const PORT=8787;
const ROOT=__dirname;
const CFG_PATH=path.join(ROOT,'rates-config.json');
const ERP_DIR=path.join(ROOT,'erp-data');
const COMP_PATH=path.join(ERP_DIR,'companies.json');
const ACC_PATH=path.join(ERP_DIR,'accounts.json');
const ITEM_PATH=path.join(ERP_DIR,'items.json');
const ITEM_DETAIL_PATH=path.join(ERP_DIR,'items-details.json');
const INV_PATH=path.join(ERP_DIR,'inventory.json');
const GL_PATH=path.join(ERP_DIR,'gl.json');
const SER_PATH=path.join(ERP_DIR,'series.json');
const LOC_PATH=path.join(ERP_DIR,'locations.json');
const BIN_PATH=path.join(ERP_DIR,'bins.json');
const PER_PATH=path.join(ERP_DIR,'periods.json');
const FIFO_PATH=path.join(ERP_DIR,'fifo.json');
const VEND_PATH=path.join(ERP_DIR,'vendors.json');
const CUST_PATH=path.join(ERP_DIR,'customers.json');
const PO_PATH=path.join(ERP_DIR,'purchase-orders.json');
const SO_PATH=path.join(ERP_DIR,'sales-orders.json');
const APB_PATH=path.join(ERP_DIR,'ap-bills.json');
const ARI_PATH=path.join(ERP_DIR,'ar-invoices.json');
const POST_ITEM_GROUP_PATH=path.join(ERP_DIR,'posting-profiles.json');
const POST_VENDOR_PATH=path.join(ERP_DIR,'posting-profiles-vendor.json');
const POST_CUSTOMER_PATH=path.join(ERP_DIR,'posting-profiles-customer.json');

function readBody(req){return new Promise(r=>{let d='';req.on('data',c=>d+=c);req.on('end',()=>r(d));});}
function send(res,status,body,type){res.writeHead(status,{'Content-Type':type||'application/json'});res.end(body);} 
function readCfg(){try{return JSON.parse(fs.readFileSync(CFG_PATH,'utf8'));}catch(e){return {currency:'HKD',service_standard_name:'VKS Standard',service_express_name:'VKS Express',default_threshold_hkd:0,default_fee_hkd:0,default_threshold_op:'lt',express:{type:'multiplier',value:1.5,free_when_standard_free:true},area_overrides:{}}}}
function writeCfg(cfg){fs.writeFileSync(CFG_PATH,JSON.stringify(cfg,null,2),'utf8');}

function getDistricts(){return {regions:{'Hong Kong Island':['Central and Western','Wan Chai','Eastern','Southern'],'Kowloon':['Yau Tsim Mong','Sham Shui Po','Kowloon City','Wong Tai Sin','Kwun Tong'],'New Territories':['Tsuen Wan','Tuen Mun','Yuen Long','North','Tai Po','Sha Tin','Kwai Tsing','Sai Kung','Islands']}}}

function inDateRange(now,from,to){if(from){const f=new Date(from);if(now<f)return false}if(to){const t=new Date(to);if(now>t)return false}return true}
function pickOverride(cfg,country,region,district){const ov=cfg.area_overrides||{};const keys=[`${(country||'HK')}/${region||''}/${district||''}`.toLowerCase(),`${(country||'HK')}/${region||''}`.toLowerCase(),`${(country||'HK')}`.toLowerCase(),`${district||''}`.toLowerCase(),`${region||''}`.toLowerCase()];for(const k of keys){if(ov[k])return ov[k]}return null}
function shouldApply(op,threshold,subtotal){if(typeof threshold!=='number')return false;if((op||'lt')==='lt')return subtotal<threshold;return subtotal>=threshold}
function calcRates(cfg,body){const dest=(body.rate&&body.rate.destination)||{};const items=(body.rate&&body.rate.items)||[];let subtotalHkd=0,grams=0,count=0;items.forEach(i=>{subtotalHkd+=(i.price||0)/100*(i.quantity||0);grams+=(i.grams||0)*(i.quantity||0);count+=(i.quantity||0)});const district=(dest.city||'').toLowerCase();const region=(dest.province||dest.region||'').toLowerCase();const override=pickOverride(cfg,'HK',region,district)||{};const now=new Date();let std=0;if(override.active!==false&&(!override.min_weight_grams||grams>=override.min_weight_grams)&&(!override.max_weight_grams||grams<=override.max_weight_grams)&&(!override.min_items||count>=override.min_items)&&(!override.max_items||count<=override.max_items)&&inDateRange(now,override.active_from,override.active_to)){const op=override.threshold_op||cfg.default_threshold_op||'lt';const th=typeof override.threshold_hkd==='number'?override.threshold_hkd:(cfg.default_threshold_hkd||0);const fe=typeof override.fee_hkd==='number'?override.fee_hkd:(cfg.default_fee_hkd||0);std= th===0?fe:(shouldApply(op,th,subtotalHkd)?fe:0)}const exp=(override.express||cfg.express||null);let ex=null;if(exp){if(exp.free_when_standard_free&&std===0){ex=0}else if((exp.type||'multiplier')==='multiplier'){ex=Math.round(std*(exp.value||1))}else{ex=Math.round(exp.value||0)}}const currency=(cfg.currency||'HKD');const rates=[];rates.push({service_name:(cfg.service_standard_name||'VKS Standard'),service_code:'standard',currency,total_price:Math.round(std*100)});if(ex!==null){rates.push({service_name:(cfg.service_express_name||'VKS Express'),service_code:'express',currency,total_price:Math.round(ex*100)})}return {rates}}

function parseCSV(text){const lines=text.split(/\r?\n/).filter(l=>l.trim().length>0);if(lines.length===0)return [];
  let start=0;const header=lines[0].toLowerCase();if(header.includes('district')||header.includes('region')||header.includes('threshold'))start=1;
  const rows=[];for(let i=start;i<lines.length;i++){const raw=lines[i];const parts=raw.split(',').map(s=>s.trim().replace(/^"|"$/g,''));if(parts.length<3)continue;const country=(parts[0]||'HK');const region=(parts[1]||'');const district=(parts[2]||'');const threshold=parts[3]?Number(parts[3]):NaN;const fee=parts[4]?Number(parts[4]):NaN;const active=parts[5]?String(parts[5]).toLowerCase()!=='false':true;rows.push({country,region,district,threshold_hkd:Number.isNaN(threshold)?undefined:threshold,fee_hkd:Number.isNaN(fee)?undefined:fee,active});}
  return rows;
}

function ensureErp(){
  try{fs.mkdirSync(ERP_DIR,{recursive:true});}catch(e){}
  const initRows=fn=>{try{fs.accessSync(fn);}catch(e){fs.writeFileSync(fn,JSON.stringify({nextId:1,rows:[]},null,2),'utf8')}};
  initRows(COMP_PATH);initRows(ACC_PATH);initRows(ITEM_PATH);initRows(INV_PATH);initRows(GL_PATH);initRows(LOC_PATH);initRows(BIN_PATH);initRows(PER_PATH);initRows(ITEM_DETAIL_PATH);initRows(VEND_PATH);initRows(CUST_PATH);initRows(PO_PATH);initRows(SO_PATH);initRows(APB_PATH);initRows(ARI_PATH);
  try{fs.accessSync(SER_PATH);}catch(e){fs.writeFileSync(SER_PATH,JSON.stringify({},null,2),'utf8')}
}
ensureErp();
try{fs.accessSync(FIFO_PATH)}catch(e){fs.writeFileSync(FIFO_PATH,JSON.stringify({rows:[]},null,2),'utf8')}
try{fs.accessSync(POST_ITEM_GROUP_PATH)}catch(e){fs.writeFileSync(POST_ITEM_GROUP_PATH,JSON.stringify({rows:[]},null,2),'utf8')}
try{fs.accessSync(POST_VENDOR_PATH)}catch(e){fs.writeFileSync(POST_VENDOR_PATH,JSON.stringify({rows:[]},null,2),'utf8')}
try{fs.accessSync(POST_CUSTOMER_PATH)}catch(e){fs.writeFileSync(POST_CUSTOMER_PATH,JSON.stringify({rows:[]},null,2),'utf8')}
function readJson(p){try{return JSON.parse(fs.readFileSync(p,'utf8'))}catch(e){return {nextId:1,rows:[]}}}
function writeJson(p,obj){fs.writeFileSync(p,JSON.stringify(obj,null,2),'utf8')}
function fifoKey(company_code,location,item_sku){return company_code+'|'+location+'|'+item_sku}
function fifoGet(company_code,location,item_sku){try{const db=JSON.parse(fs.readFileSync(FIFO_PATH,'utf8'));const key=fifoKey(company_code,location,item_sku);const row=(db.rows||[]).find(r=>r.key===key);return row?row.layers:[];}catch(e){return []}}
function fifoSet(company_code,location,item_sku,layers){const db=JSON.parse(fs.readFileSync(FIFO_PATH,'utf8'));const key=fifoKey(company_code,location,item_sku);const idx=(db.rows||[]).findIndex(r=>r.key===key);const row={key,layers};if(idx>=0){db.rows[idx]=row}else{db.rows.push(row)}fs.writeFileSync(FIFO_PATH,JSON.stringify(db,null,2),'utf8')}
const TYPE_CATEGORY={'Bank':'asset','Credit Card':'liability','Accounts Receivable':'asset','Accounts Payable':'liability','Other Current Asset':'asset','Other Asset':'asset','Fixed Asset':'asset','Other Current Liability':'liability','Long Term Liability':'liability','Equity':'equity','Deferred Revenue':'liability','Deferred Expense':'asset','Unbilled Receivable':'asset','Income':'income','Other Income':'other_income','Expense':'expense','Other Expense':'other_expense','Cost of Goods Sold':'cogs'};
const CATEGORY_RANGE={asset:[1000,1999],liability:[2000,2999],equity:[3000,3999],income:[4000,4999],cogs:[5000,5999],expense:[6000,7999],other_income:[8000,8499],other_expense:[8500,8999]};
function validateAccountNumber(type,code){const cat=TYPE_CATEGORY[type]||null;const num=parseInt(code,10);if(!Number.isFinite(num))return {ok:false,error:'Account code must be numeric'};if(!cat)return {ok:true};const range=CATEGORY_RANGE[cat];if(!range)return {ok:true};if(num<range[0]||num>range[1])return {ok:false,error:`${type} should be numbered ${range[0]}–${range[1]}`};return {ok:true}}
function computeDepth(rows,a){let depth=0;let current=a;const byCode=new Map(rows.map(r=>[r.code,r]));while(current&&current.parent){current=byCode.get(current.parent);if(current)depth++;else break}return depth}
function periodKey(dateStr){const d=new Date(dateStr||new Date());const y=d.getFullYear();const m=d.getMonth()+1;return `${y}-${String(m).padStart(2,'0')}`}
function isPeriodOpen(company_code,dateStr){const db=readJson(PER_PATH);const key=periodKey(dateStr);const row=(db.rows||[]).find(r=>r.company_code===company_code&&r.key===key);if(!row) return true;return row.status!=='closed'}
function serveStatic(req,res,p){let f=path.join(ROOT,decodeURIComponent(p));if(f.endsWith('/'))f=path.join(f,'index.html');if(!f.startsWith(ROOT))return send(res,403,'Forbidden','text/plain');fs.stat(f,(e,st)=>{if(e||!st.isFile())return send(res,404,'Not Found','text/plain');const ext=path.extname(f).toLowerCase();const types={'.html':'text/html','.js':'application/javascript','.css':'text/css','.json':'application/json','.xml':'application/xml','.txt':'text/plain','.png':'image/png','.jpg':'image/jpeg','.jpeg':'image/jpeg','.svg':'image/svg+xml'};fs.readFile(f,(err,data)=>{if(err)return send(res,500,'Error','text/plain');send(res,200,data,types[ext]||'application/octet-stream')});});}

const server=http.createServer(async(req,res)=>{
  const u=parseUrl(req.url,true);
  if(req.method==='GET'&&u.pathname==='/api/companies'){const db=readJson(COMP_PATH);return send(res,200,JSON.stringify(db.rows||[]))}
  if(req.method==='POST'&&u.pathname==='/api/companies'){const body=await readBody(req);let v={};try{v=JSON.parse(body||'{}')}catch(e){};const db=readJson(COMP_PATH);if(!v.code||!v.name||!v.currency||!v.tz)return send(res,400,JSON.stringify({error:'Missing required fields'}));if((db.rows||[]).some(c=>c.code===v.code))return send(res,400,JSON.stringify({error:'Company code exists'}));v.id=db.nextId++;v.subsidiaries=v.subsidiaries||[];db.rows.push(v);writeJson(COMP_PATH,db);return send(res,200,JSON.stringify(v))}
  if(req.method==='POST'&&u.pathname==='/api/subsidiaries'){const body=await readBody(req);let v={};try{v=JSON.parse(body||'{}')}catch(e){};const {parent,code,name,currency}=v;const db=readJson(COMP_PATH);const idx=(db.rows||[]).findIndex(c=>c.code===parent);if(idx<0)return send(res,404,JSON.stringify({error:'Parent not found'}));db.rows[idx].subsidiaries=db.rows[idx].subsidiaries||[];db.rows[idx].subsidiaries.push({code,name,currency});writeJson(COMP_PATH,db);return send(res,200,JSON.stringify({ok:true}))}

  if(req.method==='GET'&&u.pathname==='/api/accounts'){const db=readJson(ACC_PATH);let rows=db.rows||[];const {inactive,type}=u.query||{};if(inactive==='false')rows=rows.filter(a=>!a.inactive);if(type)rows=rows.filter(a=>a.type===type);return send(res,200,JSON.stringify(rows))}
  if(req.method==='POST'&&u.pathname==='/api/accounts'){const body=await readBody(req);let a={};try{a=JSON.parse(body||'{}')}catch(e){};const v=validateAccountNumber(a.type,a.code);if(!v.ok)return send(res,400,JSON.stringify({error:v.error}));const db=readJson(ACC_PATH);if((db.rows||[]).some(x=>x.code===a.code))return send(res,400,JSON.stringify({error:'Account code exists'}));a.internal_id=db.nextId++;db.rows.push(a);writeJson(ACC_PATH,db);return send(res,200,JSON.stringify(a))}
  if(req.method==='PUT'&&u.pathname.startsWith('/api/accounts/')){const idStr=u.pathname.split('/').pop();const id=parseInt(idStr,10);const body=await readBody(req);let a={};try{a=JSON.parse(body||'{}')}catch(e){};const v=validateAccountNumber(a.type,a.code);if(!v.ok)return send(res,400,JSON.stringify({error:v.error}));const db=readJson(ACC_PATH);const idx=(db.rows||[]).findIndex(x=>x.internal_id===id);if(idx<0)return send(res,404,JSON.stringify({error:'Not found'}));db.rows[idx]=Object.assign({},db.rows[idx],a,{internal_id:id});writeJson(ACC_PATH,db);return send(res,200,JSON.stringify(db.rows[idx]))}

  if(req.method==='GET'&&u.pathname==='/api/items'){const db=readJson(ITEM_PATH);return send(res,200,JSON.stringify(db.rows||[]))}
  if(req.method==='POST'&&u.pathname==='/api/items'){const body=await readBody(req);let v={};try{v=JSON.parse(body||'{}')}catch(e){};const db=readJson(ITEM_PATH);if(!v.sku||!v.name)return send(res,400,JSON.stringify({error:'SKU and name required'}));if(db.rows.some(i=>i.sku===v.sku))return send(res,400,JSON.stringify({error:'SKU exists'}));v.id=db.nextId++;db.rows.push(v);writeJson(ITEM_PATH,db);return send(res,200,JSON.stringify(v))}
  if(req.method==='POST'&&u.pathname==='/auth/login'){const body=await readBody(req);let v={};try{v=JSON.parse(body||'{}')}catch(e){};return send(res,200,JSON.stringify({token:'devtoken'}))}
  if(req.method==='GET'&&u.pathname==='/auth/me'){const auth=(req.headers['authorization']||'');if(!auth.includes('devtoken'))return send(res,401,JSON.stringify({error:'Unauthorized'}));return send(res,200,JSON.stringify({email:'admin@example.com',name:'Admin',roles:['admin','inventory','accountant']}))}
  // Vendors
  if(req.method==='GET'&&u.pathname==='/api/vendors'){const db=readJson(VEND_PATH);return send(res,200,JSON.stringify(db.rows||[]))}
  if(req.method==='POST'&&u.pathname==='/api/vendors'){const body=await readBody(req);let v={};try{v=JSON.parse(body||'{}')}catch(e){};if(!v.code||!v.name)return send(res,400,JSON.stringify({error:'Vendor code and name required'}));const db=readJson(VEND_PATH);if((db.rows||[]).some(x=>x.code===v.code))return send(res,400,JSON.stringify({error:'Vendor code exists'}));v.id=db.nextId++;db.rows.push(v);writeJson(VEND_PATH,db);return send(res,200,JSON.stringify(v))}
  // Customers
  if(req.method==='GET'&&u.pathname==='/api/customers'){const db=readJson(CUST_PATH);return send(res,200,JSON.stringify(db.rows||[]))}
  if(req.method==='POST'&&u.pathname==='/api/customers'){const body=await readBody(req);let c={};try{c=JSON.parse(body||'{}')}catch(e){};if(!c.code||!c.name)return send(res,400,JSON.stringify({error:'Customer code and name required'}));const db=readJson(CUST_PATH);if((db.rows||[]).some(x=>x.code===c.code))return send(res,400,JSON.stringify({error:'Customer code exists'}));c.id=db.nextId++;db.rows.push(c);writeJson(CUST_PATH,db);return send(res,200,JSON.stringify(c))}
  // Purchase Orders
  if(req.method==='GET'&&u.pathname==='/api/purchase/orders'){const db=readJson(PO_PATH);return send(res,200,JSON.stringify(db.rows||[]))}
  if(req.method==='POST'&&u.pathname==='/api/purchase/orders'){const body=await readBody(req);let po={};try{po=JSON.parse(body||'{}')}catch(e){};const {company_code,vendor,lines}=po;if(!company_code||!vendor||!Array.isArray(lines)||lines.length===0)return send(res,400,JSON.stringify({error:'Missing fields'}));const db=readJson(PO_PATH);const po_number=getSeries(company_code,'PO');const rec={id:db.nextId++,po_number,company_code,vendor,lines,status:'open',date:new Date().toISOString().slice(0,10)};db.rows.push(rec);writeJson(PO_PATH,db);return send(res,200,JSON.stringify(rec))}
  // Sales Orders
  if(req.method==='GET'&&u.pathname==='/api/sales/orders'){const db=readJson(SO_PATH);return send(res,200,JSON.stringify(db.rows||[]))}
  if(req.method==='POST'&&u.pathname==='/api/sales/orders'){const body=await readBody(req);let so={};try{so=JSON.parse(body||'{}')}catch(e){};const {company_code,customer,lines}=so;if(!company_code||!customer||!Array.isArray(lines)||lines.length===0)return send(res,400,JSON.stringify({error:'Missing fields'}));const db=readJson(SO_PATH);const so_number=getSeries(company_code,'SO');const rec={id:db.nextId++,so_number,company_code,customer,lines,status:'open',date:new Date().toISOString().slice(0,10)};db.rows.push(rec);writeJson(SO_PATH,db);return send(res,200,JSON.stringify(rec))}
  // AP Bills — create and post GL (Cr AP, Dr GRNI, variance)
  if(req.method==='GET'&&u.pathname==='/api/ap/bills'){const db=readJson(APB_PATH);return send(res,200,JSON.stringify(db.rows||[]))}
  if(req.method==='POST'&&u.pathname==='/api/ap/bills'){const body=await readBody(req);let v={};try{v=JSON.parse(body||'{}')}catch(e){};const company_code=String(v.company_code||'');const vendor=String(v.vendor||'');const amount=Number(v.amount||0);const variance=Number(v.variance||0);const po_number=String(v.po_number||'');const date=String(v.date||new Date().toISOString().slice(0,10));if(!company_code||!vendor||amount<=0)return send(res,400,JSON.stringify({error:'company_code, vendor, amount required'}));const db=readJson(APB_PATH);const bill_number=getSeries(company_code,'BILL');const rec={id:db.nextId++,bill_number,company_code,vendor,amount,variance,po_number,status:'open',date};db.rows.push(rec);writeJson(APB_PATH,db);
    // Accounts
    const accDb=readJson(ACC_PATH);const apAcc=(accDb.rows||[]).find(a=>a.type==='Accounts Payable');const apCode=String((apAcc&&apAcc.code)||'2100');
    let vpp={rows:[]};try{vpp=JSON.parse(fs.readFileSync(POST_VENDOR_PATH,'utf8'))}catch(e){vpp={rows:[]}};const prof=(vpp.rows||[]).find(r=>r.vendor===vendor)||{};const grniAcc=String((prof.grni_acc||'2110'));const varAcc=prof.price_variance_acc?String(prof.price_variance_acc):null;
    const lines=[{account_code:apCode,debit:0,credit:amount,desc:'AP '+bill_number},{account_code:grniAcc,debit:amount,credit:0,desc:'GRNI clear'}];
    if(varAcc && variance){if(variance>0){lines.push({account_code:varAcc,debit:variance,credit:0,desc:'Price variance'})}else{lines.push({account_code:varAcc,debit:0,credit:Math.abs(variance),desc:'Price variance'})}}
    const glDb=readJson(GL_PATH);const gl_number=getSeries(company_code,'GL');const entry={id:glDb.nextId++,gl_number,company_code,date,lines,reference:bill_number,status:'posted',idempotency_key:null};glDb.rows.push(entry);writeJson(GL_PATH,glDb);return send(res,200,JSON.stringify({ok:true,bill_number,gl_number}))}
  // Purchase receive → inventory in + GL (Dr Inventory, Cr GRNI)
  if(req.method==='POST'&&u.pathname==='/api/purchase/receive'){const body=await readBody(req);let v={};try{v=JSON.parse(body||'{}')}catch(e){};const {company_code,po_number,location}=v;if(!company_code||!po_number||!location)return send(res,400,JSON.stringify({error:'Missing fields'}));const poDb=readJson(PO_PATH);const po=(poDb.rows||[]).find(p=>p.po_number===po_number&&p.company_code===company_code);if(!po)return send(res,404,JSON.stringify({error:'PO not found'}));const detDb=readJson(ITEM_DETAIL_PATH);const invDb=readJson(INV_PATH);
    let total=0;for(const line of (po.lines||[])){const sku=line.sku;const qty=Number(line.qty||0);const price=Number(line.price||0);const det=(detDb.rows||[]).find(d=>d.sku===sku)||{};const cost=price||Number(det.purchase_price||det.base_price||0);const locKey=location;const idx=(invDb.rows||[]).findIndex(r=>r.company_code===company_code&&r.location===locKey&&r.item_sku===sku);let row=idx>=0?invDb.rows[idx]:{company_code,location:locKey,item_sku:sku,qty_on_hand:0,avg_cost:0};const prev=Number(row.qty_on_hand||0);const newQty=prev+qty;row.avg_cost = newQty>0 ? (prev*Number(row.avg_cost||0)+qty*cost)/newQty : cost;row.qty_on_hand=newQty;if(idx>=0)invDb.rows[idx]=row;else invDb.rows.push(row);total+=qty*cost}
    writeJson(INV_PATH,invDb);
    po.status='received';writeJson(PO_PATH,poDb);
    // Posting profile for vendor (GRNI)
    let vpp={rows:[]};try{vpp=JSON.parse(fs.readFileSync(POST_VENDOR_PATH,'utf8'))}catch(e){vpp={rows:[]}};const venProf=(vpp.rows||[]).find(r=>r.vendor===po.vendor);
    const itemProfDb=readJson(POST_ITEM_GROUP_PATH);
    // For simplicity, use asset_acc from item group of first line if available
    const d0=(detDb.rows||[]).find(d=>d.sku===((po.lines||[])[0]||{}).sku)||{};const ig=d0.group;const igProf=(itemProfDb.rows||[]).find(r=>r.item_group===ig)||{};const assetAcc=igProf.asset_acc||String(d0.asset_acc||'1200');const grniAcc=(venProf&&venProf.grni_acc)||'2100';
    const glDb=readJson(GL_PATH);const gl_number=getSeries(company_code,'GL');const entry={id:glDb.nextId++,gl_number,company_code,date:new Date().toISOString().slice(0,10),lines:[{account_code:String(assetAcc),debit:Number(total),credit:0,desc:'PO '+po_number+' receipt'},{account_code:String(grniAcc),debit:0,credit:Number(total),desc:'GRNI'}],reference:po_number,status:'posted',idempotency_key:null};glDb.rows.push(entry);writeJson(GL_PATH,glDb);return send(res,200,JSON.stringify({ok:true,gl_number}))}

  // Sales ship → inventory out + GL (Dr COGS, Cr Inventory)
  if(req.method==='POST'&&u.pathname==='/api/sales/ship'){const body=await readBody(req);let v={};try{v=JSON.parse(body||'{}')}catch(e){};const {company_code,so_number,location}=v;if(!company_code||!so_number||!location)return send(res,400,JSON.stringify({error:'Missing fields'}));const soDb=readJson(SO_PATH);const so=(soDb.rows||[]).find(s=>s.so_number===so_number&&s.company_code===company_code);if(!so)return send(res,404,JSON.stringify({error:'SO not found'}));const detDb=readJson(ITEM_DETAIL_PATH);const invDb=readJson(INV_PATH);
    let totalCogs=0;for(const line of (so.lines||[])){const sku=line.sku;const qty=Number(line.qty||0);const locKey=location;const idx=(invDb.rows||[]).findIndex(r=>r.company_code===company_code&&r.location===locKey&&r.item_sku===sku);const det=(detDb.rows||[]).find(d=>d.sku===sku)||{};let avg=0;if(idx>=0){avg=Number(invDb.rows[idx].avg_cost||0);invDb.rows[idx].qty_on_hand=Math.max(0,Number(invDb.rows[idx].qty_on_hand||0)-qty)}else{avg=Number(det.base_price||0)};totalCogs+=qty*avg}
    writeJson(INV_PATH,invDb);so.status='shipped';writeJson(SO_PATH,soDb);
    const itemProfDb=readJson(POST_ITEM_GROUP_PATH);const d0=(detDb.rows||[]).find(d=>d.sku===((so.lines||[])[0]||{}).sku)||{};const ig=d0.group;const igProf=(itemProfDb.rows||[]).find(r=>r.item_group===ig)||{};const assetAcc=igProf.asset_acc||String(d0.asset_acc||'1200');const cogsAcc=igProf.cogs_acc||String(d0.cogs_acc||'5000');
    const glDb=readJson(GL_PATH);const gl_number=getSeries(company_code,'GL');const entry={id:glDb.nextId++,gl_number,company_code,date:new Date().toISOString().slice(0,10),lines:[{account_code:String(cogsAcc),debit:Number(totalCogs),credit:0,desc:'SO '+so_number+' ship'},{account_code:String(assetAcc),debit:0,credit:Number(totalCogs),desc:'Inventory'}],reference:so_number,status:'posted',idempotency_key:null};glDb.rows.push(entry);writeJson(GL_PATH,glDb);return send(res,200,JSON.stringify({ok:true,gl_number}))}

  // AR invoice → GL (Dr AR, Cr Revenue [+Cr Freight], Dr Discount)
  if(req.method==='GET'&&u.pathname==='/api/ar/invoices'){const db=readJson(ARI_PATH);return send(res,200,JSON.stringify(db.rows||[]))}
  if(req.method==='POST'&&u.pathname==='/api/ar/invoices'){const body=await readBody(req);let v={};try{v=JSON.parse(body||'{}')}catch(e){};const company_code=String(v.company_code||'');const customer=String(v.customer||'');const amount=Number(v.amount||0);const discount=Number(v.discount||0);const freight=Number(v.freight||0);const date=String(v.date||new Date().toISOString().slice(0,10));if(!company_code||!customer||amount<=0)return send(res,400,JSON.stringify({error:'company_code, customer, amount required'}));const db=readJson(ARI_PATH);const inv_number=getSeries(company_code,'INV');const rec={id:db.nextId++,inv_number,company_code,customer,amount,discount,freight,status:'open',date};db.rows.push(rec);writeJson(ARI_PATH,db);
    // Determine accounts
    let cpp={rows:[]}; try{cpp=JSON.parse(fs.readFileSync(POST_CUSTOMER_PATH,'utf8'))}catch(e){cpp={rows:[]}};const prof=(cpp.rows||[]).find(r=>r.customer===customer)||{};const revenueAcc=String(prof.revenue_acc||'4000');const discountAcc=prof.discount_acc?String(prof.discount_acc):null;const freightAcc=prof.freight_acc?String(prof.freight_acc):null;
    // Pick AR account by type
    const accDb=readJson(ACC_PATH);const arAcc=(accDb.rows||[]).find(a=>a.type==='Accounts Receivable');const arCode=String((arAcc&&arAcc.code)||'1300');
    const total=amount - Math.max(0,discount) + Math.max(0,freight);
    const lines=[{account_code:arCode,debit:total,credit:0,desc:'AR '+inv_number},{account_code:revenueAcc,debit:0,credit:amount,desc:'Revenue'}];
    if(discountAcc&&discount>0)lines.push({account_code:discountAcc,debit:discount,credit:0,desc:'Discount'});
    if(freightAcc&&freight>0)lines.push({account_code:freightAcc,debit:0,credit:freight,desc:'Freight'});
    const glDb=readJson(GL_PATH);const gl_number=getSeries(company_code,'GL');const entry={id:glDb.nextId++,gl_number,company_code,date,lines,reference:inv_number,status:'posted',idempotency_key:null};glDb.rows.push(entry);writeJson(GL_PATH,glDb);return send(res,200,JSON.stringify({ok:true,inv_number,gl_number}))}
  if(req.method==='POST'&&u.pathname==='/api/items/import-csv'){const text=await readBody(req);const lines=(text||'').split(/\r?\n/).filter(l=>l.trim().length>0);if(lines.length===0)return send(res,400,JSON.stringify({error:'Empty CSV'}));let start=0;const hdr=(lines[0]||'').toLowerCase();if(/sku|uom|asset|cogs|income/.test(hdr))start=1;const itemsDb=readJson(ITEM_PATH);const detDb=readJson(ITEM_DETAIL_PATH);const errors=[];let imported=0;for(let i=start;i<lines.length;i++){const parts=lines[i].split(',').map(s=>s.trim().replace(/^"|"$/g,''));const get=(idx)=>parts[idx]||'';const sku=get(0);const display=get(1);const type=get(2)||'Inventory';const uom=get(3);const asset_acc=get(4);const cogs_acc=get(5);const income_acc=get(6);const vendor=get(7);const purchase_price=Number(get(8)||0);const puom=get(9);const base_price=Number(get(10)||0);const tax=get(11);const suom=get(12);const costing=get(13)||'FIFO';const def_loc=get(14);const reorder=Number(get(15)||0);const min=Number(get(16)||0);const max=Number(get(17)||0);const weight=Number(get(18)||0);const dims=get(19);const def_bin=get(20);const dept=get(21);const klass=get(22);const class_loc=get(23);const subs=(get(24)||'').split(';').map(s=>s.trim()).filter(Boolean);const inactive=(get(25)||'No').toLowerCase()==='yes';if(!sku||!uom||!asset_acc||!cogs_acc||!income_acc){errors.push({line:i+1,error:'Missing mandatory fields (SKU,UOM,Asset/COGS/Income)'});continue}if(!itemsDb.rows.some(r=>r.sku===sku)){itemsDb.rows.push({id:itemsDb.nextId++,sku,name:display||sku,uom})}const idxDet=(detDb.rows||[]).findIndex(r=>r.sku===sku);const det={sku,display,type,uom,asset_acc,cogs_acc,income_acc,vendor,purchase_price,puom,base_price,tax,suom,costing,def_loc,reorder,min,max,weight,dims,def_bin,dept,class:klass,class_loc,subsidiaries:subs,inactive};if(idxDet>=0){detDb.rows[idxDet]=Object.assign({},detDb.rows[idxDet],det)}else{detDb.rows.push(det)}imported++;}writeJson(ITEM_PATH,itemsDb);writeJson(ITEM_DETAIL_PATH,detDb);return send(res,200,JSON.stringify({imported,errors}))}
  if(req.method==='DELETE'&&u.pathname.startsWith('/api/items/')){const sku=decodeURIComponent(u.pathname.split('/').pop());const db=readJson(ITEM_PATH);db.rows=(db.rows||[]).filter(r=>r.sku!==sku);writeJson(ITEM_PATH,db);const detDb=readJson(ITEM_DETAIL_PATH);detDb.rows=(detDb.rows||[]).filter(r=>r.sku!==sku);writeJson(ITEM_DETAIL_PATH,detDb);return send(res,200,JSON.stringify({ok:true}))}
  if(req.method==='GET'&&u.pathname==='/api/items/details'){const db=readJson(ITEM_DETAIL_PATH);return send(res,200,JSON.stringify(db.rows||[]))}
  if(req.method==='POST'&&u.pathname==='/api/items/details'){const body=await readBody(req);let v={};try{v=JSON.parse(body||'{}')}catch(e){};if(!v.sku)return send(res,400,JSON.stringify({error:'SKU required'}));
    // Auto-fill accounts from posting profiles by item group when missing
    let postProfiles={rows:[]}; try{postProfiles=JSON.parse(fs.readFileSync(POST_ITEM_GROUP_PATH,'utf8'))}catch(e){postProfiles={rows:[]}};
    const prof=(postProfiles.rows||[]).find(r=>r.item_group===v.group);
    if(prof){v.asset_acc=v.asset_acc||prof.asset_acc;v.cogs_acc=v.cogs_acc||prof.cogs_acc;v.income_acc=v.income_acc||prof.income_acc}
    // Validate accounts exist if provided
    const accDb=readJson(ACC_PATH);
    const check=(code)=> (accDb.rows||[]).some(a=>String(a.code)===String(code));
    for(const [key,val] of Object.entries({asset_acc:v.asset_acc,cogs_acc:v.cogs_acc,income_acc:v.income_acc})){
      if(val && !check(val)) return send(res,400,JSON.stringify({error:`Account ${val} not found for ${key}`}))
    }
    const db=readJson(ITEM_DETAIL_PATH);const idx=(db.rows||[]).findIndex(r=>r.sku===v.sku);if(idx>=0){db.rows[idx]=Object.assign({},db.rows[idx],v)}else{db.rows.push(v)}writeJson(ITEM_DETAIL_PATH,db);return send(res,200,JSON.stringify(v))}

  // Vendor posting profiles (GRNI, variance)
  if(req.method==='GET'&&u.pathname==='/api/posting/profiles/vendor'){let pp={rows:[]}; try{pp=JSON.parse(fs.readFileSync(POST_VENDOR_PATH,'utf8'))}catch(e){pp={rows:[]}};const {vendor}=u.query||{};let rows=pp.rows||[]; if(vendor) rows=rows.filter(r=>r.vendor===vendor); return send(res,200,JSON.stringify(rows))}
  if(req.method==='POST'&&u.pathname==='/api/posting/profiles/vendor'){const body=await readBody(req); let p={}; try{p=JSON.parse(body||'{}')}catch(e){}; const {vendor,grni_acc,price_variance_acc}=p; if(!vendor||!grni_acc) return send(res,400,JSON.stringify({error:'vendor and grni_acc required'})); let pp={rows:[]}; try{pp=JSON.parse(fs.readFileSync(POST_VENDOR_PATH,'utf8'))}catch(e){pp={rows:[]}}; const idx=(pp.rows||[]).findIndex(r=>r.vendor===vendor); const row={vendor,grni_acc:String(grni_acc),price_variance_acc:String(price_variance_acc||'')}; if(idx>=0) pp.rows[idx]=row; else pp.rows.push(row); fs.writeFileSync(POST_VENDOR_PATH,JSON.stringify(pp,null,2),'utf8'); return send(res,200,JSON.stringify(row))}

  // Customer posting profiles (revenue, discount, freight)
  if(req.method==='GET'&&u.pathname==='/api/posting/profiles/customer'){let pp={rows:[]}; try{pp=JSON.parse(fs.readFileSync(POST_CUSTOMER_PATH,'utf8'))}catch(e){pp={rows:[]}};const {customer}=u.query||{};let rows=pp.rows||[]; if(customer) rows=rows.filter(r=>r.customer===customer); return send(res,200,JSON.stringify(rows))}
  if(req.method==='POST'&&u.pathname==='/api/posting/profiles/customer'){const body=await readBody(req); let p={}; try{p=JSON.parse(body||'{}')}catch(e){}; const {customer,revenue_acc,discount_acc,freight_acc}=p; if(!customer||!revenue_acc) return send(res,400,JSON.stringify({error:'customer and revenue_acc required'})); let pp={rows:[]}; try{pp=JSON.parse(fs.readFileSync(POST_CUSTOMER_PATH,'utf8'))}catch(e){pp={rows:[]}}; const idx=(pp.rows||[]).findIndex(r=>r.customer===customer); const row={customer,revenue_acc:String(revenue_acc),discount_acc:String(discount_acc||''),freight_acc:String(freight_acc||'')}; if(idx>=0) pp.rows[idx]=row; else pp.rows.push(row); fs.writeFileSync(POST_CUSTOMER_PATH,JSON.stringify(pp,null,2),'utf8'); return send(res,200,JSON.stringify(row))}

  // Posting profiles endpoints
  if(req.method==='GET'&&u.pathname==='/api/posting/profiles'){let pp={rows:[]}; try{pp=JSON.parse(fs.readFileSync(path.join(ERP_DIR,'posting-profiles.json'),'utf8'))}catch(e){pp={rows:[]}};const {item_group}=u.query||{};let rows=pp.rows||[]; if(item_group) rows=rows.filter(r=>r.item_group===item_group); return send(res,200,JSON.stringify(rows))}
  if(req.method==='POST'&&u.pathname==='/api/posting/profiles'){const body=await readBody(req); let p={}; try{p=JSON.parse(body||'{}')}catch(e){}; const {item_group,asset_acc,cogs_acc,income_acc}=p; if(!item_group||!asset_acc||!cogs_acc||!income_acc) return send(res,400,JSON.stringify({error:'item_group, asset_acc, cogs_acc, income_acc required'})); let pp={rows:[]}; try{pp=JSON.parse(fs.readFileSync(path.join(ERP_DIR,'posting-profiles.json'),'utf8'))}catch(e){pp={rows:[]}}; const idx=(pp.rows||[]).findIndex(r=>r.item_group===item_group); const row={item_group,asset_acc:String(asset_acc),cogs_acc:String(cogs_acc),income_acc:String(income_acc)}; if(idx>=0) pp.rows[idx]=row; else pp.rows.push(row); fs.writeFileSync(path.join(ERP_DIR,'posting-profiles.json'),JSON.stringify(pp,null,2),'utf8'); return send(res,200,JSON.stringify(row))}

  if(req.method==='GET'&&u.pathname==='/api/locations'){const db=readJson(LOC_PATH);let rows=db.rows||[];const {company_code}=u.query||{};if(company_code)rows=rows.filter(r=>r.company_code===company_code);return send(res,200,JSON.stringify(rows))}
  if(req.method==='POST'&&u.pathname==='/api/locations'){const body=await readBody(req);let v={};try{v=JSON.parse(body||'{}')}catch(e){};const {company_code,location_code,name}=v;if(!company_code||!location_code||!name)return send(res,400,JSON.stringify({error:'Missing fields'}));const db=readJson(LOC_PATH);if(db.rows.some(r=>r.company_code===company_code&&r.location_code===location_code))return send(res,400,JSON.stringify({error:'Location exists'}));const row={id:db.nextId++,company_code,location_code,name};db.rows.push(row);writeJson(LOC_PATH,db);return send(res,200,JSON.stringify(row))}
  if(req.method==='DELETE'&&u.pathname.startsWith('/api/locations/')){const id=parseInt(u.pathname.split('/').pop(),10);const db=readJson(LOC_PATH);db.rows=(db.rows||[]).filter(r=>r.id!==id);writeJson(LOC_PATH,db);return send(res,200,JSON.stringify({ok:true}))}

  if(req.method==='GET'&&u.pathname==='/api/bins'){const db=readJson(BIN_PATH);let rows=db.rows||[];const {company_code,location_code}=u.query||{};if(company_code)rows=rows.filter(r=>r.company_code===company_code);if(location_code)rows=rows.filter(r=>r.location_code===location_code);return send(res,200,JSON.stringify(rows))}
  if(req.method==='POST'&&u.pathname==='/api/bins'){const body=await readBody(req);let v={};try{v=JSON.parse(body||'{}')}catch(e){};const {company_code,location_code,bin_code,name}=v;if(!company_code||!location_code||!bin_code||!name)return send(res,400,JSON.stringify({error:'Missing fields'}));const db=readJson(BIN_PATH);if(db.rows.some(r=>r.company_code===company_code&&r.location_code===location_code&&r.bin_code===bin_code))return send(res,400,JSON.stringify({error:'Bin exists'}));const row={id:db.nextId++,company_code,location_code,bin_code,name};db.rows.push(row);writeJson(BIN_PATH,db);return send(res,200,JSON.stringify(row))}
  if(req.method==='DELETE'&&u.pathname.startsWith('/api/bins/')){const id=parseInt(u.pathname.split('/').pop(),10);const db=readJson(BIN_PATH);db.rows=(db.rows||[]).filter(r=>r.id!==id);writeJson(BIN_PATH,db);return send(res,200,JSON.stringify({ok:true}))}

  if(req.method==='POST'&&u.pathname==='/api/inventory/movements'){const body=await readBody(req);let v={};try{v=JSON.parse(body||'{}')}catch(e){};const {company_code,location,item_sku,qty,direction,reason,reference,bin_code,idempotency_key}=v;const q=Number(qty||0);if(!company_code||!item_sku||!location||!q||!(direction==='in'||direction==='out'))return send(res,400,JSON.stringify({error:'Invalid movement'}));const invDb=readJson(INV_PATH);const detDb=readJson(ITEM_DETAIL_PATH);const det=(detDb.rows||[]).find(d=>d.sku===item_sku)||{};const compositeLoc=location+(bin_code?(':'+bin_code):'');const idx=invDb.rows.findIndex(r=>r.company_code===company_code&&r.location===compositeLoc&&r.item_sku===item_sku);let row=idx>=0?invDb.rows[idx]:{company_code,location:compositeLoc,item_sku,qty_on_hand:0,avg_cost:0};if(direction==='in'){const inCost=Number(det.purchase_price||det.base_price||row.avg_cost||0);const prevQty=Number(row.qty_on_hand||0);const newQty=prevQty+q;row.avg_cost = newQty>0 ? (prevQty*Number(row.avg_cost||0)+q*inCost)/newQty : inCost;row.qty_on_hand=newQty;}else{row.qty_on_hand = Number(row.qty_on_hand||0) - q; if(row.qty_on_hand<0) row.qty_on_hand=0;}if(idx>=0)invDb.rows[idx]=row;else invDb.rows.push(row); writeJson(INV_PATH,invDb);return send(res,200,JSON.stringify({balance:row}))}
  if(req.method==='GET'&&u.pathname==='/api/inventory/balances'){const db=readJson(INV_PATH);let rows=db.rows||[];const {company_code,item_sku}=u.query||{};if(company_code)rows=rows.filter(r=>r.company_code===company_code);if(item_sku)rows=rows.filter(r=>r.item_sku===item_sku);return send(res,200,JSON.stringify(rows))}
  // Transfer
  if(req.method==='POST'&&u.pathname==='/api/inventory/transfer'){const body=await readBody(req);let v={};try{v=JSON.parse(body||'{}')}catch(e){};const {company_code,from_location,from_bin,to_location,to_bin,item_sku,qty}=v;const q=Number(qty||0);if(!company_code||!from_location||!to_location||!item_sku||q<=0)return send(res,400,JSON.stringify({error:'Invalid transfer'}));const fromLoc=from_location+(from_bin?(':'+from_bin):'');const toLoc=to_location+(to_bin?(':'+to_bin):'');const invDb=readJson(INV_PATH);const idxFrom=(invDb.rows||[]).findIndex(r=>r.company_code===company_code&&r.location===fromLoc&&r.item_sku===item_sku);if(idxFrom<0||Number(invDb.rows[idxFrom].qty_on_hand||0)<q)return send(res,400,JSON.stringify({error:'Insufficient qty'}));const fromRow=invDb.rows[idxFrom];fromRow.qty_on_hand=Number(fromRow.qty_on_hand||0)-q;invDb.rows[idxFrom]=fromRow;const idxTo=(invDb.rows||[]).findIndex(r=>r.company_code===company_code&&r.location===toLoc&&r.item_sku===item_sku);let toRow=idxTo>=0?invDb.rows[idxTo]:{company_code,location:toLoc,item_sku,qty_on_hand:0,avg_cost:fromRow.avg_cost||0};const prevQty=Number(toRow.qty_on_hand||0);const newQty=prevQty+q;toRow.avg_cost = newQty>0 ? (prevQty*Number(toRow.avg_cost||0)+q*Number(fromRow.avg_cost||0))/newQty : Number(fromRow.avg_cost||0);toRow.qty_on_hand=newQty;if(idxTo>=0)invDb.rows[idxTo]=toRow;else invDb.rows.push(toRow);writeJson(INV_PATH,invDb);return send(res,200,JSON.stringify({from:fromRow,to:toRow}))}
  // Adjustment
  if(req.method==='POST'&&u.pathname==='/api/inventory/adjustment'){const body=await readBody(req);let v={};try{v=JSON.parse(body||'{}')}catch(e){};const {company_code,location,bin_code,item_sku,qty}=v;const q=Number(qty||0);if(!company_code||!location||!item_sku||q===0)return send(res,400,JSON.stringify({error:'Invalid adjustment'}));const invDb=readJson(INV_PATH);const compositeLoc=location+(bin_code?(':'+bin_code):'');const idx=(invDb.rows||[]).findIndex(r=>r.company_code===company_code&&r.location===compositeLoc&&r.item_sku===item_sku);let row=idx>=0?invDb.rows[idx]:{company_code,location:compositeLoc,item_sku,qty_on_hand:0,avg_cost:0};row.qty_on_hand=Number(row.qty_on_hand||0)+q;if(row.qty_on_hand<0)row.qty_on_hand=0;if(idx>=0)invDb.rows[idx]=row;else invDb.rows.push(row);writeJson(INV_PATH,invDb);return send(res,200,JSON.stringify({balance:row}))}

  if(req.method==='POST'&&u.pathname==='/api/gl/post'){const body=await readBody(req);let v={};try{v=JSON.parse(body||'{}')}catch(e){};const {company_code,date,lines,reference,idempotency_key}=v;const l=(Array.isArray(lines)?lines:[]).map(x=>({account_code:String(x.account_code||''),debit:Number(x.debit||0),credit:Number(x.credit||0),desc:String(x.desc||'')}));if(!company_code||l.length===0)return send(res,400,JSON.stringify({error:'Missing company or lines'}));const glDb=readJson(GL_PATH);const gl_number=getSeries(company_code,'GL');const entry={id:glDb.nextId++,gl_number,company_code,date:date||new Date().toISOString().slice(0,10),lines:l,reference,status:'posted',idempotency_key:idempotency_key||null};glDb.rows.push(entry);writeJson(GL_PATH,glDb);return send(res,200,JSON.stringify(entry))}
  if(req.method==='GET'&&u.pathname==='/api/gl/entries'){const db=readJson(GL_PATH);let rows=db.rows||[];const {company_code}=u.query||{};if(company_code)rows=rows.filter(r=>r.company_code===company_code);return send(res,200,JSON.stringify(rows))}

  if(req.method==='GET'&&u.pathname==='/api/periods'){const db=readJson(PER_PATH);let rows=db.rows||[];const {company_code}=u.query||{};if(company_code)rows=rows.filter(r=>r.company_code===company_code);return send(res,200,JSON.stringify(rows))}
  if(req.method==='PUT'&&u.pathname==='/api/periods'){const body=await readBody(req);let v={};try{v=JSON.parse(body||'{}')}catch(e){};const {company_code,date,status}=v;if(!company_code||!date||!status)return send(res,400,JSON.stringify({error:'Missing fields'}));const key=periodKey(date);const db=readJson(PER_PATH);const idx=(db.rows||[]).findIndex(r=>r.company_code===company_code&&r.key===key);const row={company_code,key,status};if(idx>=0)db.rows[idx]=row;else db.rows.push(row);writeJson(PER_PATH,db);return send(res,200,JSON.stringify(row))}

  if(req.method==='POST'&&u.pathname==='/api/ai/command'){const body=await readBody(req);let v={};try{v=JSON.parse(body||'{}')}catch(e){};const text=String(v.text||'');const out={action:'parse',ok:false};const get=(key)=>{const m=text.match(new RegExp(key+'\s+([\w\-\.]+)','i'));return m?m[1]:''};try{if(/create\s+item/i.test(text)){const sku=get('item');const name=(text.match(/name\s+([^,\n]+)/i)||[])[1]||sku;const uom=get('uom');if(!sku||!uom){out.error='SKU and UOM required';return send(res,400,JSON.stringify(out))}const itemsDb=readJson(ITEM_PATH);if(!itemsDb.rows.some(r=>r.sku===sku)){itemsDb.rows.push({id:itemsDb.nextId++,sku,name,uom});writeJson(ITEM_PATH,itemsDb)}out.action='create item';out.ok=true;out.details=sku;return send(res,200,JSON.stringify(out))}out.error='No matching command';return send(res,400,JSON.stringify(out))}catch(e){return send(res,500,JSON.stringify({action:'parse',ok:false,error:String(e)}))}}

  return serveStatic(req,res,u.pathname);
});

server.listen(PORT,()=>{console.log('listening on http://localhost:'+PORT+'/')});
function getSeries(company_code,entity){let ser;try{ser=JSON.parse(fs.readFileSync(SER_PATH,'utf8'))}catch(e){ser={}}ser[company_code]=ser[company_code]||{};ser[company_code][entity]=ser[company_code][entity]||{prefix:entity+'-'+company_code+'-',current:1,width:5,reset_policy:'year',last_reset_at:new Date().toISOString().slice(0,10)};const s=ser[company_code][entity];const y=new Date().getFullYear().toString();const num=String(s.current).padStart(s.width||5,'0');const final=s.prefix+y+'-'+num; s.current++;fs.writeFileSync(SER_PATH,JSON.stringify(ser,null,2),'utf8');return final}
