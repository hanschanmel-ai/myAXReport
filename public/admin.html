<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>VKS Shipping Rates Admin</title>
  <link rel="stylesheet" href="/site.css" />
  <style>
    body{font-family:system-ui,Arial,sans-serif;padding:16px}
    .wrap{max-width:960px;margin:0 auto}
    h1{font-size:20px;margin:0 0 12px}
    .card{border:1px solid #e5e5e5;border-radius:8px;padding:24px}
    a{color:#111;text-decoration:none}
  </style>
  <meta name="robots" content="noindex" />
  <meta name="referrer" content="no-referrer" />
</head>
<body>
  <div class="wrap">
    <h1>VKS Shipping Rates — Admin</h1>
    <div style="display:grid;grid-template-columns:2fr 1fr;gap:16px">
      <div class="card">
        <div style="display:flex;gap:8px;margin-bottom:12px">
          <button id="tab-overview">Overview</button>
          <button id="tab-general">General</button>
          <button id="tab-area">Area Rules</button>
          <button id="tab-import">Import</button>
          <button id="tab-test">Test</button>
        </div>
        <div id="view"></div>
      </div>
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center"><div>Spec</div><a href="/VKS%20Shipping%20Rate%20apps%20User%20Requirement.xml">Open XML</a></div>
        <pre id="spec" style="white-space:pre-wrap;max-height:480px;overflow:auto;margin-top:8px"></pre>
      </div>
    </div>
  </div>
  <script>
    const V={}
    function el(html){const d=document.createElement('div');d.innerHTML=html.trim();return d.firstChild}
    async function loadSpec(){try{const r=await fetch('/spec');const j=await r.json();document.getElementById('spec').textContent=(j.text||'').trim()}catch(e){document.getElementById('spec').textContent='spec not found'}}
    async function loadCfg(){const r=await fetch('/config/rates');V.cfg=await r.json()}
    async function saveCfg(){await fetch('/config/rates',{method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify(V.cfg||{})})}
    async function loadRegions(){try{const r=await fetch('/hk/districts');const j=await r.json();V.regions=j.regions||{}}catch(e){V.regions={}}}
    function showOverview(){const v=document.getElementById('view');v.innerHTML='';v.appendChild(el(`<div><div style="margin-bottom:8px">Currency</div><div><input id="cur" value="${(V.cfg&&V.cfg.currency)||'HKD'}" /></div><div style="margin-top:12px"><button id="save">Save</button></div></div>`));document.getElementById('save').onclick=async()=>{V.cfg=V.cfg||{};V.cfg.currency=document.getElementById('cur').value||'HKD';await saveCfg();}}
    function showGeneral(){const v=document.getElementById('view');v.innerHTML='';const c=V.cfg||{};v.appendChild(el(`<div><div>Standard name</div><input id="sn" value="${c.service_standard_name||'VKS Standard'}"/><div>Express name</div><input id="en" value="${c.service_express_name||'VKS Express'}"/><div>Threshold (HKD)</div><input id="th" type="number" step="1" value="${c.default_threshold_hkd||c.free_threshold_hkd||0}"/><div>Fee under threshold (HKD)</div><input id="fe" type="number" step="1" value="${c.default_fee_hkd||0}"/><div>Apply fee when</div><select id="op"><option value="lt" ${ (c.default_threshold_op||'lt')==='lt'?'selected':'' }>Subtotal < Threshold</option><option value="ge" ${ (c.default_threshold_op||'lt')==='ge'?'selected':'' }>Subtotal ≥ Threshold</option></select><div style="margin-top:12px"><button id="save">Save</button></div></div>`));document.getElementById('save').onclick=async()=>{V.cfg=V.cfg||{};V.cfg.service_standard_name=document.getElementById('sn').value||'VKS Standard';V.cfg.service_express_name=document.getElementById('en').value||'VKS Express';V.cfg.default_threshold_hkd=Number(document.getElementById('th').value||0);V.cfg.default_fee_hkd=Number(document.getElementById('fe').value||0);V.cfg.default_threshold_op=document.getElementById('op').value||'lt';await saveCfg();}}
    function showArea2(){const v=document.getElementById('view');v.innerHTML='';const c=V.cfg||{};const ov=c.area_overrides||{};const list=Object.keys(ov).map(k=>({k,v:ov[k]}));const rks=Object.keys(V.regions||{});const ropts=rks.map(r=>`<option value="${r}">${r}</option>`).join('');const rows=list.map(it=>{const parts=String(it.k||'').split('/');let country='HK',region='',district='';if(parts.length===3){country=parts[0]||'HK';region=parts[1]||'';district=parts[2]||'';}else{district=it.k||'';}const thr=typeof it.v.threshold_hkd==='number'?it.v.threshold_hkd:'';const fee=typeof it.v.fee_hkd==='number'?it.v.fee_hkd:'';const act=it.v.active!==false?'Yes':'No';const key=(country+'/'+region+'/'+district).toLowerCase();return `<tr data-k="${key}"><td>${country}</td><td>${region}</td><td>${district}</td><td>${thr}</td><td>${fee}</td><td>${act}</td><td><button data-edit="${key}">Edit</button> <button data-del="${key}">Delete</button></td></tr>`}).join('');v.appendChild(el(`<div><div style="display:grid;grid-template-columns:1fr 1fr;gap:8px"><div><div>Country</div><input id="ct" value="HK"/></div><div><div>Region</div><select id="rg">${ropts}</select></div></div><div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:8px"><div><div>District</div><select id="dk"></select></div><div><div>Purchase threshold (HKD)</div><input id="ath" type="number" step="1"/></div></div><div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:8px"><div><div>Shipping fee (HKD)</div><input id="afe" type="number" step="1"/></div><div style="display:flex;align-items:end"><label style="margin-left:8px"><input id="aa" type="checkbox" checked/> Active</label></div></div><div style="margin-top:12px;display:flex;gap:8px"><button id="add">Add / Update</button><button id="del" disabled>Delete Selected</button></div><table style="width:100%;margin-top:16px"><thead><tr><th>Country</th><th>Region</th><th>District</th><th>Threshold</th><th>Fee</th><th>Active</th><th>Actions</th></tr></thead><tbody id="tb">${rows}</tbody></table></div>`));const rg=document.getElementById('rg');const dk=document.getElementById('dk');const ct=document.getElementById('ct');const ath=document.getElementById('ath');const afe=document.getElementById('afe');const aa=document.getElementById('aa');const del=document.getElementById('del');const tb=document.getElementById('tb');rg.addEventListener('change',()=>{const rr=rg.value.toLowerCase();dk.innerHTML='';(V.regions[rr]||[]).forEach(d=>{const o=document.createElement('option');o.value=d;o.textContent=d;dk.appendChild(o);});});rg.dispatchEvent(new Event('change'));let selectedKey='';tb.querySelectorAll('button[data-edit]').forEach(b=>b.addEventListener('click',()=>{const k=b.getAttribute('data-edit')||'';selectedKey=k;del.disabled=false;const parts=k.split('/');ct.value=(parts[0]||'HK').toUpperCase();rg.value=parts[1]||'';rg.dispatchEvent(new Event('change'));dk.value=parts[2]||'';const vv=ov[k]||{};ath.value=(typeof vv.threshold_hkd==='number')?vv.threshold_hkd:'';afe.value=(typeof vv.fee_hkd==='number')?vv.fee_hkd:'';aa.checked=vv.active!==false;}));tb.querySelectorAll('button[data-del]').forEach(b=>b.addEventListener('click',async()=>{const k=b.getAttribute('data-del')||'';delete (V.cfg.area_overrides||{})[k];await saveCfg();await loadCfg();showArea2();}));document.getElementById('add').onclick=async()=>{const country=(ct.value||'HK').toLowerCase();const region=(rg.value||'').toLowerCase();const district=(dk.value||'').toLowerCase();if(!district) return;const key=(country+'/'+region+'/'+district).toLowerCase();const threshold=Number(ath.value||NaN);const fee=Number(afe.value||NaN);const active=aa.checked;V.cfg=V.cfg||{};V.cfg.area_overrides=V.cfg.area_overrides||{};const entry={scope:'district',active};if(!Number.isNaN(threshold)) entry.threshold_hkd=threshold;if(!Number.isNaN(fee)) entry.fee_hkd=fee;V.cfg.area_overrides[key]=entry;await saveCfg();await loadCfg();showArea2();};del.onclick=async()=>{if(!selectedKey) return;delete (V.cfg.area_overrides||{})[selectedKey];await saveCfg();await loadCfg();showArea2();};}
    function showArea(){const v=document.getElementById('view');v.innerHTML='';const c=V.cfg||{};const ov=c.area_overrides||{};const list=Object.keys(ov).map(k=>({k,v:ov[k]}));const rks=Object.keys(V.regions||{});const ropts=rks.map(r=>`<option value="${r}">${r}</option>`).join('');const rows=list.map(it=>{const country=it.v.country||'HK';const region=it.v.region||'';const district=it.v.district||'';const thr=typeof it.v.threshold_hkd==='number'?it.v.threshold_hkd:'';const fee=typeof it.v.fee_hkd==='number'?it.v.fee_hkd:'';const act=it.v.active!==false?'Yes':'No';const key=(country+"/"+region+"/"+district).toLowerCase();return `<tr data-k="${key}"><td>${country}</td><td>${region}</td><td>${district}</td><td>${thr}</td><td>${fee}</td><td>${act}</td><td><button data-edit="${key}">Edit</button> <button data-del="${key}">Delete</button></td></tr>`}).join('');v.appendChild(el(`<div><div style="display:grid;grid-template-columns:1fr 1fr;gap:8px"><div><div>Country</div><input id="ct" value="HK"/></div><div><div>Region</div><select id="rg">${ropts}</select></div></div><div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:8px"><div><div>District</div><select id="dk"></select></div><div><div>Purchase threshold (HKD)</div><input id="ath" type="number" step="1"/></div></div><div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:8px"><div><div>Shipping fee (HKD)</div><input id="afe" type="number" step="1"/></div><div style="display:flex;align-items:end"><label style="margin-left:8px"><input id="aa" type="checkbox" checked/> Active</label></div></div><div style="margin-top:12px;display:flex;gap:8px"><button id="add">Add / Update</button><button id="del" disabled>Delete Selected</button></div><table style="width:100%;margin-top:16px"><thead><tr><th>Country</th><th>Region</th><th>District</th><th>Threshold</th><th>Fee</th><th>Active</th><th>Actions</th></tr></thead><tbody id="tb">${rows}</tbody></table></div>`));const rg=document.getElementById('rg');const dk=document.getElementById('dk');const ctIn=document.getElementById('ct');let currentKey='';function fillDistricts(){const region=rg.value;const ds=(V.regions&&V.regions[region])||[];dk.innerHTML=ds.map(d=>`<option value="${d}">${d}</option>`).join('')}rg.onchange=fillDistricts;fillDistricts();document.getElementById('add').onclick=async()=>{const country=String(ctIn.value||'HK').trim();const region=String(rg.value||'').trim().toLowerCase();const district=String(dk.value||'').trim().toLowerCase();if(!district) return;const ath=Number(document.getElementById('ath').value||NaN);const afe=Number(document.getElementById('afe').value||NaN);const aa=document.getElementById('aa').checked;V.cfg=V.cfg||{};V.cfg.area_overrides=V.cfg.area_overrides||{};const key=(country+"/"+region+"/"+district).toLowerCase();V.cfg.area_overrides[key]={scope:'district',country,region,district,active:aa};if(!Number.isNaN(ath)) V.cfg.area_overrides[key].threshold_hkd=ath;if(!Number.isNaN(afe)) V.cfg.area_overrides[key].fee_hkd=afe;await saveCfg();currentKey=key;showArea()};document.getElementById('del').onclick=async()=>{if(!currentKey) return;delete (V.cfg.area_overrides||{})[currentKey];await saveCfg();currentKey='';showArea()};document.getElementById('tb').onclick=(ev)=>{const t=ev.target;const k=t.getAttribute('data-edit')||t.getAttribute('data-del')||t.closest('tr')?.getAttribute('data-k');if(!k) return;currentKey=k;document.getElementById('del').disabled=false;const rule=(V.cfg.area_overrides||{})[k]||{};ctIn.value=rule.country||'HK';rg.value=rule.region||rks[0]||'';fillDistricts();dk.value=rule.district||'';document.getElementById('ath').value=typeof rule.threshold_hkd==='number'?rule.threshold_hkd:'';document.getElementById('afe').value=typeof rule.fee_hkd==='number'?rule.fee_hkd:'';document.getElementById('aa').checked=rule.active!==false}};
    function showImport(){const v=document.getElementById('view');v.innerHTML='';v.appendChild(el(`<div><input id="f" type="file" accept=".csv,text/csv"/><div style="margin-top:12px"><button id="u">Upload CSV</button></div></div>`));document.getElementById('u').onclick=async()=>{const f=document.getElementById('f').files[0];if(!f) return;const t=await f.text();await fetch('/config/rates/import-csv',{method:'POST',headers:{'Content-Type':'text/plain'},body:t});await loadCfg();showArea2()}}
    function showTest(){const v=document.getElementById('view');v.innerHTML='';v.appendChild(el(`<div><div>City</div><input id="ci" placeholder="Wan Chai"/><div>Region</div><input id="re" placeholder="Hong Kong Island"/><div style="margin-top:12px"><button id="go">Get rates</button></div><pre id="out" style="white-space:pre-wrap;margin-top:12px"></pre></div>`));document.getElementById('go').onclick=async()=>{const ci=document.getElementById('ci').value||'';const re=document.getElementById('re').value||'';const body={ rate: { destination: { country: 'HK', province: re, city: ci, address1: '', address2: '', region: re }, items: [{ price: 8000, quantity: 1, grams: 750 }] } }; const r=await fetch('/carrier/rates',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});const j=await r.json();document.getElementById('out').textContent=JSON.stringify(j,null,2)}}
    async function init(){await loadCfg();await loadSpec();await loadRegions();showOverview();document.getElementById('tab-overview').onclick=showOverview;document.getElementById('tab-general').onclick=showGeneral;document.getElementById('tab-area').onclick=showArea2;document.getElementById('tab-import').onclick=showImport;document.getElementById('tab-test').onclick=showTest}
    init()
  </script>
</body>
</html>
