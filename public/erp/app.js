const state={user:null,companies:[],coa:[],items:[],vendors:[],customers:[],gl:[],apBills:[],arInvoices:[],employees:[]};
function save(){localStorage.setItem('erp_state',JSON.stringify(state));}
function load(){const s=localStorage.getItem('erp_state');if(s){Object.assign(state,JSON.parse(s));}}
load();

function qs(x){return document.querySelector(x)}
function renderNav(){document.querySelectorAll('.ns-leftnav a[href^="#"]').forEach(a=>{a.classList.remove('active');if(location.hash===a.getAttribute('href'))a.classList.add('active')});}
function show(id){document.querySelectorAll('.panel.page').forEach(p=>p.style.display='none');const el=qs('#'+id);if(el){el.style.display='block'}else{const fallback=qs('#dashboard')||qs('#login');if(fallback)fallback.style.display='block'}
  if(id==='report-sales-customer'){reportSalesByCustomer()}
  if(id==='report-sales-item'){reportSalesByItem()}
  if(id==='report-purchase-vendor'){reportPurchaseByVendor()}
  if(id==='report-purchase-item'){reportPurchaseByItem()}
  if(id==='item-master'){const form=qs('#item-master .ns-item-form');if(form){const panels=form.querySelectorAll('div[id^="tab-"]');panels.forEach((d,i)=>{d.style.display=i===0?'block':'none'});const firstTab=form.querySelector('.tabs .tab');if(firstTab)showTab(firstTab)}}
  renderNav();}
window.addEventListener('hashchange',()=>{const id=(location.hash||'#login').slice(1);show(id)});

function onLogin(){const email=qs('#login_email').value||'';const name=qs('#login_name').value||'';if(!email||!name){alert('Enter name and email');return}state.user={email,name};save();qs('#userName').textContent=name;location.hash='#dashboard';}

function addCompany(){const code=qs('#cmp_code').value||'';const name=qs('#cmp_name').value||'';const country=qs('#cmp_country').value||'';const currency=qs('#cmp_currency').value||'';const tz=qs('#cmp_tz').value||'';const lang=qs('#cmp_lang').value||'';const fiscalStart=qs('#cmp_fiscal_start').value||'1';const fiscalPeriods=qs('#cmp_fiscal_periods').value||'12';const context=qs('#cmp_context').value||'';const taxRegime=qs('#cmp_tax_regime').value||'';const taxRate=Number(qs('#cmp_tax_rate').value||0);const multibook=qs('#cmp_multibook').value==='Yes';const bookPrimary=qs('#cmp_book_primary').value||'Primary';const bookSecondary=qs('#cmp_book_secondary').value||'';const series=qs('#cmp_series').value||'';if(!code||!name||!currency||!tz){alert('Code, name, currency, timezone required');return}
  const payload={code,name,country,currency,tz,lang,fiscal:{start_month:Number(fiscalStart),periods:Number(fiscalPeriods)},context,tax:{regime:taxRegime,rate:taxRate},multibook,books:{primary:bookPrimary,secondary:bookSecondary},series,subsidiaries:[]};
  fetch('/api/companies',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)}).then(async r=>{const out=await r.json();if(!r.ok){alert(out.error||'Error');return}state.companies.push(out);save();renderCompanies();}).catch(()=>alert('Network error'))}
function renderCompanies(){const tbody=qs('#cmp_table tbody');tbody.innerHTML='';state.companies.forEach(c=>{const tr=document.createElement('tr');tr.innerHTML=`<td>${c.code}</td><td>${c.name}</td><td>${c.currency}</td><td>${c.tz}</td><td>${c.country||''}</td><td>${c.lang||''}</td><td>${c.context||''}</td><td>${c.multibook?'Yes':'No'}</td>`;tbody.appendChild(tr);});}
function addSubsidiary(){const parent=qs('#sub_parent').value||'';const code=qs('#sub_code').value||'';const name=qs('#sub_name').value||'';const currency=qs('#sub_currency').value||'';if(!parent||!code||!name){alert('Parent, code, name required');return}
  fetch('/api/subsidiaries',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({parent,code,name,currency})}).then(async r=>{const out=await r.json();if(!r.ok){alert(out.error||'Error');return}fetch('/api/companies').then(r=>r.json()).then(rows=>{state.companies=rows;save();renderCompanies();})}).catch(()=>alert('Network error'))}

function addAccount(){const code=qs('#coa_code').value||'';const name=qs('#coa_name').value||'';const type=qs('#coa_type').value||'';if(!code||!name||!type){alert('All fields required');return}state.coa.push({code,name,type});save();renderCoa();}
function renderCoa(){const tbody=qs('#coa_table tbody');tbody.innerHTML='';const showInactive=qs('#coa_show_inactives')?qs('#coa_show_inactives').checked:false;const rows=(state.coa||[]).filter(a=>showInactive?true:!a.inactive);const byCode=new Map(rows.map(r=>[r.code,r]));rows.forEach((a,i)=>{let depth=0;let cur=a;while(cur&&cur.parent){cur=byCode.get(cur.parent);if(cur)depth++;else break}const indent=''.padStart(depth*2,'\u00A0');const tr=document.createElement('tr');tr.innerHTML=`<td><a href="#" onclick="event.preventDefault();editAccount(${i})">Edit</a></td><td><a href="#" onclick="event.preventDefault();viewAccount(${i})">View</a></td><td>${a.summary?'Yes':'No'}</td><td>${a.internal_id||i+1}</td><td>${indent}${a.code} - ${a.name}</td><td>${a.type}</td><td>${a.desc||''}</td><td>${a.currency||''}</td><td>${a.inactive?'Yes':'No'}</td>`;tbody.appendChild(tr);});}
function refreshPostingProfiles(){fetch('/api/posting/profiles').then(r=>r.json()).then(rows=>{const tbody=qs('#pp_table tbody');if(!tbody)return;tbody.innerHTML='';rows.forEach(p=>{const tr=document.createElement('tr');tr.innerHTML=`<td>${p.item_group||''}</td><td>${p.asset_acc||''}</td><td>${p.cogs_acc||''}</td><td>${p.income_acc||''}</td>`;tbody.appendChild(tr)});}).catch(()=>{})}
function addPostingProfile(){const item_group=qs('#pp_item_group')?qs('#pp_item_group').value.trim():'';const asset_acc=qs('#pp_asset')?qs('#pp_asset').value.trim():'';const cogs_acc=qs('#pp_cogs')?qs('#pp_cogs').value.trim():'';const income_acc=qs('#pp_income')?qs('#pp_income').value.trim():'';if(!item_group||!asset_acc||!cogs_acc||!income_acc){alert('Item group and accounts required');return}fetch('/api/posting/profiles',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({item_group,asset_acc,cogs_acc,income_acc})}).then(r=>r.json()).then(out=>{if(out.error){alert(out.error);return}refreshPostingProfiles();alert('Saved posting profile for '+item_group)}).catch(()=>alert('Network error'))}
function refreshVendorPostingProfiles(){fetch('/api/posting/profiles/vendor').then(r=>r.json()).then(rows=>{const tbody=qs('#pp_vendor_table tbody');if(!tbody)return;tbody.innerHTML='';rows.forEach(p=>{const tr=document.createElement('tr');tr.innerHTML=`<td>${p.vendor||''}</td><td>${p.grni_acc||''}</td><td>${p.price_variance_acc||''}</td>`;tbody.appendChild(tr)});}).catch(()=>{})}
function addVendorPostingProfile(){const vendor=qs('#pp_vendor_code')?qs('#pp_vendor_code').value.trim():'';const grni_acc=qs('#pp_vendor_grni')?qs('#pp_vendor_grni').value.trim():'';const price_variance_acc=qs('#pp_vendor_var')?qs('#pp_vendor_var').value.trim():'';if(!vendor||!grni_acc){alert('Vendor and GRNI required');return}fetch('/api/posting/profiles/vendor',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({vendor,grni_acc,price_variance_acc})}).then(r=>r.json()).then(out=>{if(out.error){alert(out.error);return}refreshVendorPostingProfiles();alert('Saved vendor posting profile for '+vendor)}).catch(()=>alert('Network error'))}
function refreshCustomerPostingProfiles(){fetch('/api/posting/profiles/customer').then(r=>r.json()).then(rows=>{const tbody=qs('#pp_customer_table tbody');if(!tbody)return;tbody.innerHTML='';rows.forEach(p=>{const tr=document.createElement('tr');tr.innerHTML=`<td>${p.customer||''}</td><td>${p.revenue_acc||''}</td><td>${p.discount_acc||''}</td><td>${p.freight_acc||''}</td>`;tbody.appendChild(tr)});}).catch(()=>{})}
function addCustomerPostingProfile(){const customer=qs('#pp_customer_code')?qs('#pp_customer_code').value.trim():'';const revenue_acc=qs('#pp_customer_rev')?qs('#pp_customer_rev').value.trim():'';const discount_acc=qs('#pp_customer_disc')?qs('#pp_customer_disc').value.trim():'';const freight_acc=qs('#pp_customer_freight')?qs('#pp_customer_freight').value.trim():'';if(!customer||!revenue_acc){alert('Customer and revenue account required');return}fetch('/api/posting/profiles/customer',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({customer,revenue_acc,discount_acc,freight_acc})}).then(r=>r.json()).then(out=>{if(out.error){alert(out.error);return}refreshCustomerPostingProfiles();alert('Saved customer posting profile for '+customer)}).catch(()=>alert('Network error'))}
function populateAccountTypes(){const sel=qs('#coa_type');sel.innerHTML='';['Bank','Credit Card','Accounts Receivable','Accounts Payable','Other Current Asset','Other Asset','Fixed Asset','Other Current Liability','Long Term Liability','Equity','Deferred Revenue','Deferred Expense','Unbilled Receivable','Income','Other Income','Expense','Other Expense','Cost of Goods Sold'].forEach(t=>{const o=document.createElement('option');o.textContent=t;sel.appendChild(o);});}
function editAccount(i){const a=state.coa[i];if(!a)return;qs('#coa_name').value=a.name||'';qs('#coa_parent').value=a.parent||'';qs('#coa_type').value=a.type||'';qs('#coa_currency').value=a.currency||'';qs('#coa_grt').value=a.grt||'Current';qs('#coa_cfrt').value=a.cfrt||'Average';qs('#coa_inventory').value=a.inventory?'Yes':'No';qs('#coa_summary').value=a.summary?'Yes':'No';qs('#coa_inactive').value=a.inactive?'Yes':'No';qs('#coa_desc').value=a.desc||'';qs('#coa_code').value=a.code||'';qs('#coa_subs').value=(a.subsidiaries||[]).join(', ');qs('#coa_book').value=a.book||'Primary Only';qs('#coa_r_dept').value=(a.r_dept||'');qs('#coa_r_class').value=(a.r_class||'');qs('#coa_r_loc').value=(a.r_loc||'');qs('#coa_bank_name').value=(a.bank_name||'');qs('#coa_bank_routing').value=(a.bank_routing||'');qs('#coa_bank_account').value=(a.bank_account||'');
  qs('#coa_save').onclick=()=>{saveAccount(i)};
}
function viewAccount(i){editAccount(i)}
function saveAccount(i){const a={};a.name=qs('#coa_name').value||'';a.parent=qs('#coa_parent').value||'';a.type=qs('#coa_type').value||'';a.currency=qs('#coa_currency').value||'';a.grt=qs('#coa_grt').value||'';a.cfrt=qs('#coa_cfrt').value||'';a.inventory=qs('#coa_inventory').value==='Yes';a.summary=qs('#coa_summary').value==='Yes';a.inactive=qs('#coa_inactive').value==='Yes';a.desc=qs('#coa_desc').value||'';a.code=qs('#coa_code').value||'';a.subsidiaries=(qs('#coa_subs').value||'').split(',').map(s=>s.trim()).filter(Boolean);a.book=qs('#coa_book').value||'Primary Only';a.r_dept=qs('#coa_r_dept').value||'';a.r_class=qs('#coa_r_class').value||'';a.r_loc=qs('#coa_r_loc').value||'';a.bank_name=qs('#coa_bank_name').value||'';a.bank_routing=qs('#coa_bank_routing').value||'';a.bank_account=qs('#coa_bank_account').value||'';
  if(!a.code||!a.name||!a.type){alert('NAME, TYPE, CODE required');return}
  const url='/api/accounts'+(typeof i==='number'&&state.coa[i]&&state.coa[i].internal_id?('/'+state.coa[i].internal_id):'');
  const method=(typeof i==='number'&&state.coa[i]&&state.coa[i].internal_id)?'PUT':'POST';
  fetch(url,{method,headers:{'Content-Type':'application/json'},body:JSON.stringify(a)}).then(async r=>{const out=await r.json();if(!r.ok){alert(out.error||'Error');return}if(method==='POST'){state.coa.push(out)}else{const idx=i;state.coa[idx]=out}save();renderCoa();alert('Saved')}).catch(()=>alert('Network error'))}
function coaReset(){qs('#coa_name').value='';qs('#coa_parent').value='';qs('#coa_currency').value='HKD';qs('#coa_grt').value='Current';qs('#coa_cfrt').value='Average';qs('#coa_inventory').value='No';qs('#coa_summary').value='No';qs('#coa_inactive').value='No';qs('#coa_desc').value='';qs('#coa_code').value='';qs('#coa_subs').value='';qs('#coa_book').value='Primary Only';qs('#coa_r_dept').value='';qs('#coa_r_class').value='';qs('#coa_r_loc').value='';qs('#coa_bank_name').value='';qs('#coa_bank_routing').value='';qs('#coa_bank_account').value=''}

function addItem(){const sku=qs('#itm_sku').value||'';const name=qs('#itm_name').value||'';const uom=qs('#itm_uom').value||'';if(!sku||!name){alert('SKU and name required');return}state.items.push({sku,name,uom});save();renderItems();}
function renderItems(){const tbody=qs('#itm_table tbody');tbody.innerHTML='';const q=(qs('#item_filter')?qs('#item_filter').value.trim().toLowerCase():'');const t=(qs('#item_filter_type')?qs('#item_filter_type').value:'');const s=(qs('#item_filter_subs')?qs('#item_filter_subs').value.trim().toLowerCase():'');(state.items||[]).filter(i=>{const text=Object.values(i).join(' ').toLowerCase();const typeOk=!t||(i.type===t);const subsOk=!s||((i.subsidiaries||[]).join(' ').toLowerCase().includes(s));return (!q||text.includes(q))&&typeOk&&subsOk}).forEach(i=>{const tr=document.createElement('tr');tr.innerHTML=`<td><input type="checkbox" data-sku="${i.sku}"></td><td><a href="#" onclick="event.preventDefault();editItem('${i.sku}')">Edit</a></td><td>${i.sku}</td><td>${i.display||i.name||''}</td><td>${i.type||''}</td><td>${i.uom||''}</td><td>${i.asset_acc||''}</td><td>${i.cogs_acc||''}</td><td>${i.income_acc||''}</td><td>${i.vendor||''}</td><td>${i.inactive?'Yes':'No'}</td>`;tbody.appendChild(tr);});}
function deleteSelectedItems(){const boxes=document.querySelectorAll('#itm_table tbody input[type="checkbox"]:checked');const skus=[...boxes].map(b=>b.dataset.sku);if(skus.length===0){alert('Select at least one item');return}if(!confirm('Delete selected items?'))return;Promise.all(skus.map(sku=>fetch('/api/items/'+encodeURIComponent(sku),{method:'DELETE'}).then(r=>r.json()))).then(()=>{state.items=(state.items||[]).filter(i=>!skus.includes(i.sku));renderItems()}).catch(()=>alert('Network error'))}
function previewItemsCSV(){const f=qs('#items_csv').files[0];if(!f){alert('Select a CSV file');return}const reader=new FileReader();reader.onload=()=>{const lines=(reader.result||'').split(/\r?\n/).filter(l=>l.trim().length>0).slice(0,6);const tbody=qs('#items_csv_preview tbody');tbody.innerHTML='';lines.forEach((line,idx)=>{const tr=document.createElement('tr');tr.innerHTML=`<td>${idx===0?'Header':idx}</td><td>${line}</td>`;tbody.appendChild(tr);});};reader.readAsText(f)}
function showTab(tab){if(!tab)return;const form=tab.closest('.ns-item-form');document.querySelectorAll('.tabs .tab').forEach(t=>t.classList.remove('active'));if(form){form.querySelectorAll('div[id^="tab-"]').forEach(d=>d.style.display='none');}
  const id=tab.getAttribute('data-tab');tab.classList.add('active');const panel=qs('#'+id);if(panel)panel.style.display='block'}
function switchTab(e){const tab=(e&& (e.currentTarget||e.target)) || null;showTab(tab)}
function showTabById(id){const tab=document.querySelector('#item-master .tabs .tab[data-tab="'+id+'"]');showTab(tab)}
function editItem(sku){const i=state.items.find(x=>x.sku===sku);if(!i)return;qs('#itm_sku').value=i.sku;qs('#itm_display').value=i.display||i.name||'';qs('#itm_type').value=i.type||'Inventory';qs('#itm_desc').value=i.desc||'';qs('#itm_subs').value=(i.subsidiaries||[]).join(',');qs('#itm_inactive').value=i.inactive?'Yes':'No';qs('#itm_group')&& (qs('#itm_group').value=i.group||'');qs('#itm_vendor_item')&& (qs('#itm_vendor_item').value=i.vendor_item||'');qs('#itm_customer_item')&& (qs('#itm_customer_item').value=i.customer_item||'');qs('#itm_barcode')&& (qs('#itm_barcode').value=i.barcode||'');qs('#itm_vendor').value=i.vendor||'';qs('#itm_purchase_price').value=i.purchase_price||0;qs('#itm_puom').value=i.puom||'';qs('#itm_po_min')&& (qs('#itm_po_min').value=i.po_min||0);qs('#itm_po_max')&& (qs('#itm_po_max').value=i.po_max||0);qs('#itm_po_mult')&& (qs('#itm_po_mult').value=i.po_mult||0);qs('#itm_po_lead')&& (qs('#itm_po_lead').value=i.po_lead||0);qs('#itm_base_price').value=i.base_price||0;qs('#itm_tax').value=i.tax||'';qs('#itm_suom').value=i.suom||'';qs('#itm_reservation')&& (qs('#itm_reservation').value=i.reservation||'Manual');qs('#itm_uom').value=i.uom||'';qs('#itm_costing').value=i.costing||'FIFO';qs('#itm_def_loc').value=i.def_loc||'';qs('#itm_reorder').value=i.reorder||0;qs('#itm_min').value=i.min||0;qs('#itm_max').value=i.max||0;qs('#itm_weight').value=i.weight||0;qs('#itm_dims').value=i.dims||'';qs('#itm_def_bin').value=i.def_bin||'';qs('#itm_def_wh')&& (qs('#itm_def_wh').value=i.def_wh||'');qs('#itm_track_batch')&& (qs('#itm_track_batch').value=i.track_batch?'Yes':'No');qs('#itm_track_serial')&& (qs('#itm_track_serial').value=i.track_serial?'Yes':'No');qs('#itm_shelf_life')&& (qs('#itm_shelf_life').value=i.shelf_life||0);qs('#itm_asset_acc').value=i.asset_acc||'';qs('#itm_cogs_acc').value=i.cogs_acc||'';qs('#itm_income_acc').value=i.income_acc||'';qs('#itm_tax_group')&& (qs('#itm_tax_group').value=i.tax_group||'');qs('#itm_commodity')&& (qs('#itm_commodity').value=i.commodity||'');qs('#itm_origin')&& (qs('#itm_origin').value=i.origin||'');qs('#itm_dept').value=i.dept||'';qs('#itm_class').value=i.class||'';qs('#itm_class_loc').value=i.class_loc||'';}
function saveItem(){const i={};i.sku=qs('#itm_sku').value||'';i.display=qs('#itm_display').value||'';i.type=qs('#itm_type').value||'Inventory';i.desc=qs('#itm_desc').value||'';i.subsidiaries=(qs('#itm_subs').value||'').split(',').map(s=>s.trim()).filter(Boolean);i.inactive=qs('#itm_inactive').value==='Yes';i.group=qs('#itm_group')?qs('#itm_group').value:'';i.vendor_item=qs('#itm_vendor_item')?qs('#itm_vendor_item').value:'';i.customer_item=qs('#itm_customer_item')?qs('#itm_customer_item').value:'';i.barcode=qs('#itm_barcode')?qs('#itm_barcode').value:'';i.vendor=qs('#itm_vendor').value||'';i.purchase_price=Number(qs('#itm_purchase_price').value||0);i.puom=qs('#itm_puom').value||'';i.po_min=Number(qs('#itm_po_min')?qs('#itm_po_min').value:0)||0;i.po_max=Number(qs('#itm_po_max')?qs('#itm_po_max').value:0)||0;i.po_mult=Number(qs('#itm_po_mult')?qs('#itm_po_mult').value:0)||0;i.po_lead=Number(qs('#itm_po_lead')?qs('#itm_po_lead').value:0)||0;i.base_price=Number(qs('#itm_base_price').value||0);i.tax=qs('#itm_tax').value||'';i.suom=qs('#itm_suom').value||'';i.reservation=qs('#itm_reservation')?qs('#itm_reservation').value:'Manual';i.uom=qs('#itm_uom').value||'';i.costing=qs('#itm_costing').value||'FIFO';i.def_loc=qs('#itm_def_loc').value||'';i.reorder=Number(qs('#itm_reorder').value||0);i.min=Number(qs('#itm_min').value||0);i.max=Number(qs('#itm_max').value||0);i.weight=Number(qs('#itm_weight').value||0);i.dims=qs('#itm_dims').value||'';i.def_bin=qs('#itm_def_bin').value||'';i.def_wh=qs('#itm_def_wh')?qs('#itm_def_wh').value:'';i.track_batch=(qs('#itm_track_batch')?qs('#itm_track_batch').value==='Yes':false);i.track_serial=(qs('#itm_track_serial')?qs('#itm_track_serial').value==='Yes':false);i.shelf_life=Number(qs('#itm_shelf_life')?qs('#itm_shelf_life').value:0)||0;i.asset_acc=qs('#itm_asset_acc').value||'';i.cogs_acc=qs('#itm_cogs_acc').value||'';i.income_acc=qs('#itm_income_acc').value||'';i.tax_group=qs('#itm_tax_group')?qs('#itm_tax_group').value:'';i.commodity=qs('#itm_commodity')?qs('#itm_commodity').value:'';i.origin=qs('#itm_origin')?qs('#itm_origin').value:'';i.dept=qs('#itm_dept').value||'';i.class=qs('#itm_class').value||'';i.class_loc=qs('#itm_class_loc').value||'';if(!i.sku||!i.uom||!i.asset_acc||!i.cogs_acc||!i.income_acc){alert('Mandatory fields missing: SKU, Base UOM, Asset/COGS/Income accounts');return}
  fetch('/api/items',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({sku:i.sku,name:i.display||i.sku,uom:i.uom})}).then(async r=>{const out=await r.json();if(!r.ok&&out.error!=='SKU exists'){alert(out.error||'Error');return}return fetch('/api/items/details',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(i)})}).then(async r=>{const det=await r.json();if(r && !r.ok){alert(det.error||'Error');return}const idx=state.items.findIndex(x=>x.sku===i.sku);if(idx>=0)state.items[idx]=Object.assign({},state.items[idx],i);else state.items.push(i);renderItems();alert('Saved');}).catch(()=>alert('Network error'))}
function recordMovement(){const company=qs('#mv_company').value||'';const loc=qs('#mv_location').value||'';const sku=qs('#mv_sku').value||'';const qty=Number(qs('#mv_qty').value||0);const dir=qs('#mv_dir').value||'in';const reason=qs('#mv_reason').value||'';if(!company||!loc||!sku||qty<=0){alert('Company, location, SKU, qty required');return}fetch('/api/inventory/movements',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({company_code:company,location:loc,item_sku:sku,qty:qty,direction:dir,reason})}).then(r=>r.json()).then(out=>{if(out.error){alert(out.error);return}refreshBalances()}).catch(()=>alert('Network error'))}
function recordTransfer(){const company=qs('#tr_company').value||'';const sku=qs('#tr_sku').value||'';const qty=Number(qs('#tr_qty').value||0);const fromLoc=qs('#tr_from_loc').value||'';const fromBin=qs('#tr_from_bin').value||'';const toLoc=qs('#tr_to_loc').value||'';const toBin=qs('#tr_to_bin').value||'';if(!company||!sku||qty<=0||!fromLoc||!toLoc){alert('Company, SKU, qty, from/to locations required');return}fetch('/api/inventory/transfer',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({company_code:company,from_location:fromLoc,from_bin:fromBin,to_location:toLoc,to_bin:toBin,item_sku:sku,qty})}).then(r=>r.json()).then(out=>{if(out.error){alert(out.error);return}refreshBalances()}).catch(()=>alert('Network error'))}
function recordAdjustment(){const company=qs('#adj_company').value||'';const location=qs('#adj_location').value||'';const bin=qs('#adj_bin').value||'';const sku=qs('#adj_sku').value||'';const qty=Number(qs('#adj_qty').value||0);const acc=qs('#adj_acc').value||'';const reason=qs('#adj_reason').value||'';const ref=qs('#adj_ref').value||'';if(!company||!location||!sku||qty===0){alert('Company, location, SKU, qty required');return}fetch('/api/inventory/adjustment',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({company_code:company,location,bin_code:bin,item_sku:sku,qty,adjustment_account:acc,reason,reference:ref})}).then(r=>r.json()).then(out=>{if(out.error){alert(out.error);return}refreshBalances();if(out.gl_number)alert('Posted GL '+out.gl_number)}).catch(()=>alert('Network error'))}
function importItemsCSV(){const f=qs('#items_csv').files[0];if(!f){alert('Select a CSV file');return}const reader=new FileReader();reader.onload=()=>{fetch('/api/items/import-csv',{method:'POST',headers:{'Content-Type':'text/plain'},body:reader.result}).then(r=>r.json()).then(out=>{if(out.error){alert(out.error);return}const tbody=qs('#items_import_errors tbody');tbody.innerHTML='';(out.errors||[]).forEach(e=>{const tr=document.createElement('tr');tr.innerHTML=`<td>${e.line}</td><td>${e.error}</td>`;tbody.appendChild(tr);});alert(`Imported ${out.imported}. Errors: ${out.errors.length}`);fetch('/api/items').then(r=>r.json()).then(rows=>{state.items=rows;return fetch('/api/items/details')}).then(r=>r.json()).then(details=>{details.forEach(d=>{const idx=state.items.findIndex(x=>x.sku===d.sku);if(idx>=0){state.items[idx]=Object.assign({},state.items[idx],d)}else{state.items.push(d)}});renderItems();});}).catch(()=>alert('Network error'))};reader.readAsText(f)}
function refreshBalances(){fetch('/api/inventory/balances').then(r=>r.json()).then(rows=>{const tbody=qs('#bal_table tbody');tbody.innerHTML='';rows.forEach(b=>{const tr=document.createElement('tr');tr.innerHTML=`<td>${b.company_code}</td><td>${b.location}</td><td>${b.item_sku}</td><td>${(b.qty_on_hand||0).toFixed(2)}</td>`;tbody.appendChild(tr);});});}
function addLocation(){const company=qs('#loc_company').value||'';const code=qs('#loc_code').value||'';const name=qs('#loc_name').value||'';if(!company||!code||!name){alert('Company, location code, name required');return}fetch('/api/locations',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({company_code:company,location_code:code,name})}).then(r=>r.json()).then(out=>{if(out.error){alert(out.error);return}refreshLocations(company)}).catch(()=>alert('Network error'))}
function refreshLocations(company){fetch('/api/locations'+(company?('?company_code='+encodeURIComponent(company)):'')).then(r=>r.json()).then(rows=>{const tbody=qs('#loc_table tbody');tbody.innerHTML='';const q=(qs('#loc_filter')?qs('#loc_filter').value.trim().toLowerCase():'');rows.filter(l=>!q||(`${l.company_code} ${l.location_code} ${l.name}`).toLowerCase().includes(q)).forEach(l=>{const tr=document.createElement('tr');tr.innerHTML=`<td><a href="#" onclick="event.preventDefault();deleteLocation(${l.id})">Delete</a></td><td>${l.company_code}</td><td>${l.location_code}</td><td>${l.name}</td>`;tbody.appendChild(tr);});});}
function addBin(){const company=qs('#bin_company').value||'';const loc=qs('#bin_loc').value||'';const code=qs('#bin_code').value||'';const name=qs('#bin_name').value||'';if(!company||!loc||!code||!name){alert('Company, location, bin, name required');return}fetch('/api/bins',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({company_code:company,location_code:loc,bin_code:code,name})}).then(r=>r.json()).then(out=>{if(out.error){alert(out.error);return}refreshBins(company,loc)}).catch(()=>alert('Network error'))}
function refreshBins(company,loc){let url='/api/bins';const Q=[];if(company)Q.push('company_code='+encodeURIComponent(company));if(loc)Q.push('location_code='+encodeURIComponent(loc));if(Q.length)url+='?'+Q.join('&');fetch(url).then(r=>r.json()).then(rows=>{const tbody=qs('#bin_table tbody');tbody.innerHTML='';const q=(qs('#bin_filter')?qs('#bin_filter').value.trim().toLowerCase():'');rows.filter(b=>!q||(`${b.company_code} ${b.location_code} ${b.bin_code} ${b.name}`).toLowerCase().includes(q)).forEach(b=>{const tr=document.createElement('tr');tr.innerHTML=`<td><a href="#" onclick="event.preventDefault();deleteBin(${b.id})">Delete</a></td><td>${b.company_code}</td><td>${b.location_code}</td><td>${b.bin_code}</td><td>${b.name}</td>`;tbody.appendChild(tr);});});}
function deleteLocation(id){fetch('/api/locations/'+id,{method:'DELETE'}).then(r=>r.json()).then(()=>refreshLocations('')).catch(()=>alert('Network error'))}
function deleteBin(id){fetch('/api/bins/'+id,{method:'DELETE'}).then(r=>r.json()).then(()=>refreshBins('', '')).catch(()=>alert('Network error'))}
function setPeriod(){const company=qs('#per_company').value||'';const date=qs('#per_date').value||'';const status=qs('#per_status').value||'';if(!company||!date||!status){alert('Company, date, status required');return}fetch('/api/periods',{method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify({company_code:company,date,status})}).then(r=>r.json()).then(out=>{if(out.error){alert(out.error);return}refreshPeriods(company)}).catch(()=>alert('Network error'))}
function refreshPeriods(company){fetch('/api/periods'+(company?('?company_code='+encodeURIComponent(company)):'')).then(r=>r.json()).then(rows=>{const tbody=qs('#per_table tbody');tbody.innerHTML='';rows.forEach(p=>{const tr=document.createElement('tr');tr.innerHTML=`<td>${p.company_code}</td><td>${p.key}</td><td>${p.status}</td>`;tbody.appendChild(tr);});});}

function addVendor(){const code=qs('#ven_code').value||'';const name=qs('#ven_name').value||'';if(!code||!name){alert('Vendor code and name required');return}fetch('/api/vendors',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({code,name})}).then(r=>r.json()).then(out=>{if(out.error){alert(out.error);return}refreshVendors()}).catch(()=>alert('Network error'))}
function refreshVendors(){fetch('/api/vendors').then(r=>r.json()).then(rows=>{state.vendors=rows;const tbody=qs('#ven_table tbody');tbody.innerHTML='';rows.forEach(v=>{const tr=document.createElement('tr');tr.innerHTML=`<td>${v.code}</td><td>${v.name}</td>`;tbody.appendChild(tr);});});}
function addBill(){const company=qs('#bill_company').value||'';const ven=qs('#bill_vendor').value||'';const amt=Number(qs('#bill_amount').value||0);const variance=Number(qs('#bill_variance')?qs('#bill_variance').value:0)||0;const po=(qs('#bill_po')?qs('#bill_po').value.trim():'');const date=(qs('#bill_date')?qs('#bill_date').value:'');if(!company||!ven||amt<=0){alert('Company, vendor and amount required');return}fetch('/api/ap/bills',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({company_code:company,vendor:ven,amount:amt,variance,po_number:po,date})}).then(r=>r.json()).then(out=>{if(out.error){alert(out.error);return}refreshBills();if(out.gl_number)alert('Bill '+out.bill_number+' — GL '+out.gl_number)}).catch(()=>alert('Network error'))}
function refreshBills(){fetch('/api/ap/bills').then(r=>r.json()).then(rows=>{state.apBills=rows;const tbody=qs('#bill_table tbody');tbody.innerHTML='';rows.forEach(b=>{const amt=Number(b.amount||0);const varc=Number(b.variance||0);const net=(amt+varc);const tr=document.createElement('tr');tr.innerHTML=`<td>${b.bill_number||''}</td><td>${b.company_code||''}</td><td>${b.vendor||''}</td><td>${b.po_number||''}</td><td>${amt.toFixed(2)}</td><td>${varc.toFixed(2)}</td><td>${net.toFixed(2)}</td><td>${b.date||''}</td><td>${b.status||''}</td>`;tbody.appendChild(tr);});});}

function addCustomer(){const code=qs('#cus_code').value||'';const name=qs('#cus_name').value||'';if(!code||!name){alert('Customer code and name required');return}fetch('/api/customers',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({code,name})}).then(r=>r.json()).then(out=>{if(out.error){alert(out.error);return}refreshCustomers()}).catch(()=>alert('Network error'))}
function refreshCustomers(){fetch('/api/customers').then(r=>r.json()).then(rows=>{state.customers=rows;const tbody=qs('#cus_table tbody');tbody.innerHTML='';rows.forEach(c=>{const tr=document.createElement('tr');tr.innerHTML=`<td>${c.code}</td><td>${c.name}</td>`;tbody.appendChild(tr);});});}
function addInvoice(){const company=qs('#inv_company').value||'';const cus=qs('#inv_customer').value||'';const amt=Number(qs('#inv_amount').value||0);const disc=Number(qs('#inv_discount')?qs('#inv_discount').value:0)||0;const freight=Number(qs('#inv_freight')?qs('#inv_freight').value:0)||0;const date=(qs('#inv_date')?qs('#inv_date').value:'');if(!company||!cus||amt<=0){alert('Company, customer and amount required');return}fetch('/api/ar/invoices',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({company_code:company,customer:cus,amount:amt,discount:disc,freight,date})}).then(r=>r.json()).then(out=>{if(out.error){alert(out.error);return}refreshInvoices();alert('Invoice '+out.inv_number+' — GL '+out.gl_number)}).catch(()=>alert('Network error'))}
function refreshInvoices(){fetch('/api/ar/invoices').then(r=>r.json()).then(rows=>{state.arInvoices=rows;const tbody=qs('#inv_table tbody');tbody.innerHTML='';rows.forEach(i=>{const amt=Number(i.amount||0);const disc=Number(i.discount||0);const freight=Number(i.freight||0);const net=(amt - disc + freight);const tr=document.createElement('tr');tr.innerHTML=`<td>${i.inv_number||''}</td><td>${i.company_code||''}</td><td>${i.customer||''}</td><td>${amt.toFixed(2)}</td><td>${disc.toFixed(2)}</td><td>${freight.toFixed(2)}</td><td>${net.toFixed(2)}</td><td>${i.date||''}</td><td>${i.status||''}</td>`;tbody.appendChild(tr);});});}

function addEmployee(){const id=qs('#emp_id').value||'';const name=qs('#emp_name').value||'';const role=qs('#emp_role').value||'';if(!id||!name){alert('Employee id and name required');return}state.employees.push({id,name,role});save();renderEmployees();}
function renderEmployees(){const tbody=qs('#emp_table tbody');tbody.innerHTML='';state.employees.forEach(e=>{const tr=document.createElement('tr');tr.innerHTML=`<td>${e.id}</td><td>${e.name}</td><td>${e.role||''}</td>`;tbody.appendChild(tr);});}

let glDraft=[];function addGLLine(){const acc=qs('#gl_account').value||'';const desc=qs('#gl_desc').value||'';const debit=Number(qs('#gl_debit').value||0);const credit=Number(qs('#gl_credit').value||0);if(!acc||(debit<=0&&credit<=0)){alert('Account and debit or credit required');return}glDraft.push({account_code:acc,desc,debit,credit});renderGLDraft()}
function renderGLDraft(){const tbody=qs('#gl_draft_table tbody');tbody.innerHTML='';let td=0,tc=0;glDraft.forEach((e,idx)=>{const tr=document.createElement('tr');tr.innerHTML=`<td>${e.account_code}</td><td>${e.desc||''}</td><td>${e.debit.toFixed(2)}</td><td>${e.credit.toFixed(2)}</td><td><a href="#" onclick="event.preventDefault();glRemove(${idx})">Remove</a></td>`;tbody.appendChild(tr);td+=e.debit;tc+=e.credit;});qs('#gl_totals').textContent=`Totals — Debit: ${td.toFixed(2)} Credit: ${tc.toFixed(2)}`}
function glRemove(i){glDraft.splice(i,1);renderGLDraft()}
function postGL(){const company=qs('#gl_company').value||'';const date=qs('#gl_date').value||'';const reference=qs('#gl_ref').value||'';if(!company||glDraft.length===0){alert('Company and lines required');return}fetch('/api/gl/post',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({company_code:company,date,reference,lines:glDraft})}).then(r=>r.json()).then(out=>{if(out.error){alert(out.error);return}glDraft=[];renderGLDraft();renderGLEntries();alert('Posted '+out.gl_number)}).catch(()=>alert('Network error'))}
function renderGLEntries(){fetch('/api/gl/entries').then(r=>r.json()).then(rows=>{const tbody=qs('#gl_table tbody');tbody.innerHTML='';rows.forEach(e=>{const tr=document.createElement('tr');tr.innerHTML=`<td>${e.gl_number}</td><td>${e.company_code}</td><td>${e.date}</td><td>${e.lines.length}</td><td>${e.status}</td>`;tbody.appendChild(tr);});});}

function init(){qs('#login_btn')&&(qs('#login_btn').onclick=onLogin);qs('#cmp_add')&&(qs('#cmp_add').onclick=addCompany);qs('#sub_add')&&(qs('#sub_add').onclick=addSubsidiary);qs('#coa_save')&&(qs('#coa_save').onclick=()=>saveAccount());qs('#coa_cancel')&&(qs('#coa_cancel').onclick=()=>alert('Canceled (prototype)'));qs('#coa_new')&&(qs('#coa_new').onclick=()=>{qs('#coa_name').value='';qs('#coa_parent').value='';qs('#coa_currency').value='HKD';qs('#coa_grt').value='Current';qs('#coa_cfrt').value='Average';qs('#coa_inventory').value='No';qs('#coa_summary').value='No';qs('#coa_inactive').value='No';qs('#coa_desc').value='';qs('#coa_code').value='';qs('#coa_subs').value='';qs('#coa_book').value='Primary Only';qs('#coa_r_dept').value='';qs('#coa_r_class').value='';qs('#coa_r_loc').value='';qs('#coa_bank_name').value='';qs('#coa_bank_routing').value='';qs('#coa_bank_account').value=''});
  if(qs('#coa_type')){populateAccountTypes();qs('#coa_type').addEventListener('change',()=>{const t=qs('#coa_type').value;qs('#bank_row').style.display=(t==='Bank'||t==='Credit Card')?'flex':'none'})}
  if(qs('#coa_show_inactives'))qs('#coa_show_inactives').addEventListener('change',renderCoa);
  document.querySelectorAll('.ns-leftgroup .group-header').forEach(h=>{h.addEventListener('click',()=>{h.parentElement.classList.toggle('open')})});
  fetch('/api/companies').then(r=>r.json()).then(rows=>{state.companies=rows;renderCompanies();});
  fetch('/api/accounts?inactive=false').then(r=>r.json()).then(rows=>{state.coa=rows;renderCoa();});
  fetch('/api/items').then(r=>r.json()).then(rows=>{state.items=rows;return fetch('/api/items/details')}).then(r=>r.json()).then(details=>{details.forEach(d=>{const idx=state.items.findIndex(x=>x.sku===d.sku);if(idx>=0){state.items[idx]=Object.assign({},state.items[idx],d)}else{state.items.push(d)}});renderItems();});
  refreshPostingProfiles();
  refreshVendorPostingProfiles();
  refreshCustomerPostingProfiles();
  document.querySelectorAll('#item-master .tabs .tab').forEach(t=>t.addEventListener('click',function(ev){ev.preventDefault();showTab(this)}));
  document.querySelectorAll('.tabs').forEach(tb=>tb.addEventListener('click',ev=>{const t=ev.target.closest('.tab');if(!t)return;ev.preventDefault();showTab(t)}));
  qs('#itm_save')&&(qs('#itm_save').onclick=saveItem);
  qs('#mv_add')&&(qs('#mv_add').onclick=recordMovement);refreshBalances();
  qs('#tr_add')&&(qs('#tr_add').onclick=recordTransfer);qs('#adj_add')&&(qs('#adj_add').onclick=recordAdjustment);qs('#items_import')&&(qs('#items_import').onclick=importItemsCSV);
  qs('#items_preview_csv')&&qs('#items_preview_csv').addEventListener('click',previewItemsCSV);
  qs('#items_delete_selected')&&qs('#items_delete_selected').addEventListener('click',deleteSelectedItems);
  qs('#item_filter')&&qs('#item_filter').addEventListener('input',renderItems);
  qs('#item_filter_type')&&qs('#item_filter_type').addEventListener('change',renderItems);
  qs('#item_filter_subs')&&qs('#item_filter_subs').addEventListener('input',renderItems);
  qs('#item_filter')&&qs('#item_filter').addEventListener('input',renderItems);
  qs('#po_filter')&&qs('#po_filter').addEventListener('input',refreshPOs);
  qs('#bill_filter_po')&&qs('#bill_filter_po').addEventListener('input',refreshBills);
  qs('#loc_filter')&&qs('#loc_filter').addEventListener('input',()=>refreshLocations(''));
  qs('#bin_filter')&&qs('#bin_filter').addEventListener('input',()=>refreshBins('', ''));
  qs('#loc_add')&&(qs('#loc_add').onclick=addLocation);qs('#bin_add')&&(qs('#bin_add').onclick=addBin);refreshLocations('');refreshBins('', '');
  qs('#per_set')&&(qs('#per_set').onclick=setPeriod);refreshPeriods('');
  qs('#gl_add_line')&&(qs('#gl_add_line').onclick=addGLLine);qs('#gl_post')&&(qs('#gl_post').onclick=postGL);renderGLEntries();
  qs('#ai_run')&&qs('#ai_run').addEventListener('click',runAi);
  qs('#po_add')&&qs('#po_add').addEventListener('click',createPO);
  qs('#po_recv')&&qs('#po_recv').addEventListener('click',receivePO);
  qs('#so_add')&&qs('#so_add').addEventListener('click',createSO);
  qs('#so_ship')&&qs('#so_ship').addEventListener('click',shipSO);
  qs('#rep_sales_cust_refresh')&&qs('#rep_sales_cust_refresh').addEventListener('click',reportSalesByCustomer);
  qs('#rep_sales_item_refresh')&&qs('#rep_sales_item_refresh').addEventListener('click',reportSalesByItem);
  qs('#rep_pur_vendor_refresh')&&qs('#rep_pur_vendor_refresh').addEventListener('click',reportPurchaseByVendor);
  qs('#rep_pur_item_refresh')&&qs('#rep_pur_item_refresh').addEventListener('click',reportPurchaseByItem);
  qs('#rep_fin_refresh')&&qs('#rep_fin_refresh').addEventListener('click',reportFinance);
  qs('#rep_fin_export')&&qs('#rep_fin_export').addEventListener('click',exportFinanceCSV);
  qs('#rep_sales_cust_export')&&qs('#rep_sales_cust_export').addEventListener('click',()=>exportXLS('#rep_sales_by_customer_table','sales_by_customer.xls'));
  qs('#rep_sales_item_export')&&qs('#rep_sales_item_export').addEventListener('click',()=>exportXLS('#rep_sales_by_item_table','sales_by_item.xls'));
  qs('#rep_pur_vendor_export')&&qs('#rep_pur_vendor_export').addEventListener('click',()=>exportXLS('#rep_pur_by_vendor_table','purchase_by_vendor.xls'));
  qs('#rep_pur_item_export')&&qs('#rep_pur_item_export').addEventListener('click',()=>exportXLS('#rep_pur_by_item_table','purchase_by_item.xls'));
  qs('#rep_sales_sub_cust')&&qs('#rep_sales_sub_cust').addEventListener('click',(e)=>{e.preventDefault();selectSales('customer')});
  qs('#rep_sales_sub_item')&&qs('#rep_sales_sub_item').addEventListener('click',(e)=>{e.preventDefault();selectSales('item')});
  qs('#rep_pur_sub_vendor')&&qs('#rep_pur_sub_vendor').addEventListener('click',(e)=>{e.preventDefault();selectPurchase('vendor')});
  qs('#rep_pur_sub_item')&&qs('#rep_pur_sub_item').addEventListener('click',(e)=>{e.preventDefault();selectPurchase('item')});
  qs('#rep_sales_cust_export')&&qs('#rep_sales_cust_export').addEventListener('click',()=>exportXLS('#rep_sales_by_customer_table','sales_by_customer.xls'));
  qs('#rep_sales_item_export')&&qs('#rep_sales_item_export').addEventListener('click',()=>exportXLS('#rep_sales_by_item_table','sales_by_item.xls'));
  qs('#rep_pur_vendor_export')&&qs('#rep_pur_vendor_export').addEventListener('click',()=>exportXLS('#rep_pur_by_vendor_table','purchase_by_vendor.xls'));
  qs('#rep_pur_item_export')&&qs('#rep_pur_item_export').addEventListener('click',()=>exportXLS('#rep_pur_by_item_table','purchase_by_item.xls'));
  document.querySelectorAll('.topbar .menu a[href^="#"]').forEach(a=>{a.addEventListener('click',e=>{e.preventDefault();const id=a.getAttribute('href').slice(1);location.hash='#'+id;show(id)})});
  qs('#ven_add').onclick=addVendor;qs('#bill_add').onclick=addBill;qs('#cus_add').onclick=addCustomer;qs('#inv_add').onclick=addInvoice;qs('#emp_add').onclick=addEmployee;refreshVendors();refreshCustomers();refreshBills();refreshInvoices();refreshPOs();refreshSOs();const id=(location.hash||'#login').slice(1);show(id);} 
if(document.readyState==='loading'){document.addEventListener('DOMContentLoaded',init)}else{init()}
window.navigate=function(id){const target=(id||'').startsWith('#')?id:('#'+id);location.hash=target;show(target.slice(1));return false}
window.goReportSalesCustomer=function(){navigate('#report-sales');selectSales('customer')}
window.goReportSalesItem=function(){navigate('#report-sales');selectSales('item')}
window.goReportPurchaseVendor=function(){navigate('#report-purchase');selectPurchase('vendor')}
window.goReportPurchaseItem=function(){navigate('#report-purchase');selectPurchase('item')}
function runAi(){const cmd=qs('#ai_cmd').value||'';if(!cmd){alert('Enter a command');return}fetch('/api/ai/command',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({text:cmd})}).then(r=>r.json()).then(out=>{const tbody=qs('#ai_table tbody');const tr=document.createElement('tr');const time=new Date().toLocaleString();tr.innerHTML=`<td>${time}</td><td>${out.action||'—'}</td><td>${out.ok?('OK '+(out.details||'')):('Error: '+(out.error||'Unknown'))}</td>`;tbody.prepend(tr);if(out.kpis){qs('#kpi_items').textContent=out.kpis.items;qs('#kpi_companies').textContent=out.kpis.companies;}}).catch(()=>alert('Network error'))}
function createPO(){const company=qs('#po_company').value||'';const vendor=qs('#po_vendor').value||'';const sku=qs('#po_sku').value||'';const qty=Number(qs('#po_qty').value||0);const price=Number(qs('#po_price').value||0);if(!company||!vendor||!sku||qty<=0){alert('Company, vendor, SKU, qty required');return}fetch('/api/purchase/orders',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({company_code:company,vendor,lines:[{sku,qty,price}]})}).then(r=>r.json()).then(out=>{if(out.error){alert(out.error);return}refreshPOs();alert('Created '+out.po_number)}).catch(()=>alert('Network error'))}
function refreshPOs(){fetch('/api/purchase/orders').then(r=>r.json()).then(rows=>{const tbody=qs('#po_table tbody');tbody.innerHTML='';rows.forEach(p=>{const tr=document.createElement('tr');tr.innerHTML=`<td>${p.po_number}</td><td>${p.company_code}</td><td>${p.vendor}</td><td>${p.status}</td>`;tbody.appendChild(tr);});});}
function receivePO(){const company=qs('#po_company').value||'';const po=qs('#po_recv_no').value||'';const loc=qs('#po_recv_loc').value||'';if(!company||!po||!loc){alert('Company, PO#, location required');return}fetch('/api/purchase/receive',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({company_code:company,po_number:po,location:loc})}).then(r=>r.json()).then(out=>{if(out.error){alert(out.error);return}refreshBalances();refreshPOs();alert('Received '+po+(out.gl_number?(' — GL '+out.gl_number):''))}).catch(()=>alert('Network error'))}
function createSO(){const company=qs('#so_company').value||'';const customer=qs('#so_customer').value||'';const sku=qs('#so_sku').value||'';const qty=Number(qs('#so_qty').value||0);if(!company||!customer||!sku||qty<=0){alert('Company, customer, SKU, qty required');return}fetch('/api/sales/orders',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({company_code:company,customer,lines:[{sku,qty}]})}).then(r=>r.json()).then(out=>{if(out.error){alert(out.error);return}refreshSOs();alert('Created '+out.so_number)}).catch(()=>alert('Network error'))}
function refreshSOs(){fetch('/api/sales/orders').then(r=>r.json()).then(rows=>{const tbody=qs('#so_table tbody');tbody.innerHTML='';rows.forEach(s=>{const tr=document.createElement('tr');tr.innerHTML=`<td>${s.so_number}</td><td>${s.company_code}</td><td>${s.customer}</td><td>${s.status}</td>`;tbody.appendChild(tr);});});}
function shipSO(){const company=qs('#so_company').value||'';const so=qs('#so_ship_no').value||'';const loc=qs('#so_ship_loc').value||'';if(!company||!so||!loc){alert('Company, SO#, location required');return}fetch('/api/sales/ship',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({company_code:company,so_number:so,location:loc})}).then(r=>r.json()).then(out=>{if(out.error){alert(out.error);return}refreshBalances();refreshSOs();alert('Shipped '+so+(out.gl_number?(' — GL '+out.gl_number):''))}).catch(()=>alert('Network error'))}
function reportSales(){fetch('/api/sales/orders').then(r=>r.json()).then(rows=>{const company=(qs('#rep_sales_company')?qs('#rep_sales_company').value.trim():'');const from=(qs('#rep_sales_from')?qs('#rep_sales_from').value:'');const to=(qs('#rep_sales_to')?qs('#rep_sales_to').value:'');const inRange=d=>{if(from&&d<from)return false;if(to&&d>to)return false;return true};const filtered=rows.filter(s=>(!company||s.company_code===company)&&inRange(String(s.date||'')));let total=0;const tbody=qs('#rep_sales_table tbody');if(!tbody)return;tbody.innerHTML='';filtered.forEach(s=>{const lines=(s.lines||[]);const amt=lines.reduce((sum,l)=>sum+Number(l.qty||0)*Number(l.price||0),0);total+=amt;const tr=document.createElement('tr');tr.innerHTML=`<td>${s.so_number}</td><td>${s.company_code||''}</td><td>${s.customer||''}</td><td>${s.date||''}</td><td>${s.status||''}</td><td>${lines.length}</td><td>${amt.toFixed(2)}</td>`;tbody.appendChild(tr)});if(qs('#rep_sales_totals'))qs('#rep_sales_totals').textContent=`Total: ${total.toFixed(2)} | Orders: ${filtered.length}`;}).catch(()=>alert('Network error'))}
function reportPurchase(){fetch('/api/purchase/orders').then(r=>r.json()).then(rows=>{const company=(qs('#rep_pur_company')?qs('#rep_pur_company').value.trim():'');const from=(qs('#rep_pur_from')?qs('#rep_pur_from').value:'');const to=(qs('#rep_pur_to')?qs('#rep_pur_to').value:'');const inRange=d=>{if(from&&d<from)return false;if(to&&d>to)return false;return true};const filtered=rows.filter(p=>(!company||p.company_code===company)&&inRange(String(p.date||'')));let total=0;const tbody=qs('#rep_pur_table tbody');if(!tbody)return;tbody.innerHTML='';filtered.forEach(p=>{const lines=(p.lines||[]);const amt=lines.reduce((sum,l)=>sum+Number(l.qty||0)*Number(l.price||0),0);total+=amt;const tr=document.createElement('tr');tr.innerHTML=`<td>${p.po_number}</td><td>${p.company_code||''}</td><td>${p.vendor||''}</td><td>${p.date||''}</td><td>${p.status||''}</td><td>${lines.length}</td><td>${amt.toFixed(2)}</td>`;tbody.appendChild(tr)});if(qs('#rep_pur_totals'))qs('#rep_pur_totals').textContent=`Total: ${total.toFixed(2)} | Orders: ${filtered.length}`;}).catch(()=>alert('Network error'))}
function reportFinance(){let url='/api/gl/entries';const company=(qs('#rep_fin_company')?qs('#rep_fin_company').value.trim():'');if(company)url+='?company_code='+encodeURIComponent(company);fetch(url).then(r=>r.json()).then(rows=>{const from=(qs('#rep_fin_from')?qs('#rep_fin_from').value:'');const to=(qs('#rep_fin_to')?qs('#rep_fin_to').value:'');const inRange=d=>{if(from&&d<from)return false;if(to&&d>to)return false;return true};const filtered=rows.filter(g=>inRange(String(g.date||'')));let td=0,tc=0;const tbody=qs('#rep_fin_table tbody');if(!tbody)return;tbody.innerHTML='';filtered.forEach(g=>{const lines=(g.lines||[]);const d=lines.reduce((sum,l)=>sum+Number(l.debit||0),0);const c=lines.reduce((sum,l)=>sum+Number(l.credit||0),0);td+=d;tc+=c;const tr=document.createElement('tr');tr.innerHTML=`<td>${g.gl_number||''}</td><td>${g.company_code||''}</td><td>${g.date||''}</td><td>${g.status||''}</td><td>${lines.length}</td><td>${d.toFixed(2)}</td><td>${c.toFixed(2)}</td>`;tbody.appendChild(tr)});if(qs('#rep_fin_totals'))qs('#rep_fin_totals').textContent=`Total Debit: ${td.toFixed(2)} | Total Credit: ${tc.toFixed(2)} | Entries: ${filtered.length}`;}).catch(()=>alert('Network error'))}
function exportCSV(tableSelector,filename){const table=qs(tableSelector);if(!table)return;const rows=[];const headers=[...table.querySelectorAll('thead tr th')].map(h=>('"'+(h.textContent||'').replace(/"/g,'""')+'"'));rows.push(headers.join(','));table.querySelectorAll('tbody tr').forEach(tr=>{const cols=[...tr.children].map(td=>('"'+(td.textContent||'').replace(/"/g,'""')+'"'));rows.push(cols.join(','))});const blob=new Blob([rows.join('\r\n')],{type:'text/csv;charset=utf-8;'});const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download=filename;a.click();setTimeout(()=>URL.revokeObjectURL(a.href),1000)}
function exportSales(){exportCSV('#rep_sales_table','sales_report.csv')}
function exportPurchase(){exportCSV('#rep_pur_table','purchase_report.csv')}
function exportFinanceCSV(){exportCSV('#rep_fin_table','finance_report.csv')}
function exportXLS(sel,filename){const table=qs(sel);if(!table)return;const html='<html><head><meta charset="UTF-8"></head><body>'+table.outerHTML+'</body></html>';const blob=new Blob([html],{type:'application/vnd.ms-excel'});const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download=filename.endsWith('.xls')?filename:(filename+'.xls');a.click();setTimeout(()=>URL.revokeObjectURL(a.href),1000)}
function selectSales(kind){qs('#rep_sales_sub_cust')&&qs('#rep_sales_sub_cust').classList.remove('active');qs('#rep_sales_sub_item')&&qs('#rep_sales_sub_item').classList.remove('active');if(qs('#rep_sales_cust_section'))qs('#rep_sales_cust_section').style.display='none';if(qs('#rep_sales_item_section'))qs('#rep_sales_item_section').style.display='none';const base='Report → Sales';const hideMain=()=>{qs('#rep_sales_table')&&(qs('#rep_sales_table').style.display='none');qs('#rep_sales_totals')&&(qs('#rep_sales_totals').style.display='none')};const showMain=()=>{qs('#rep_sales_table')&&(qs('#rep_sales_table').style.display='table');qs('#rep_sales_totals')&&(qs('#rep_sales_totals').style.display='block')};if(kind==='customer'){qs('#rep_sales_sub_cust')&&qs('#rep_sales_sub_cust').classList.add('active');if(qs('#rep_sales_cust_section'))qs('#rep_sales_cust_section').style.display='block';if(qs('#rep_sales_path'))qs('#rep_sales_path').textContent=base+' → Sales by Customer';hideMain();reportSalesByCustomer();}else if(kind==='item'){qs('#rep_sales_sub_item')&&qs('#rep_sales_sub_item').classList.add('active');if(qs('#rep_sales_item_section'))qs('#rep_sales_item_section').style.display='block';if(qs('#rep_sales_path'))qs('#rep_sales_path').textContent=base+' → Sales by Item';hideMain();reportSalesByItem();}else{if(qs('#rep_sales_path'))qs('#rep_sales_path').textContent=base;showMain();}}
function selectPurchase(kind){qs('#rep_pur_sub_vendor')&&qs('#rep_pur_sub_vendor').classList.remove('active');qs('#rep_pur_sub_item')&&qs('#rep_pur_sub_item').classList.remove('active');if(qs('#rep_pur_vendor_section'))qs('#rep_pur_vendor_section').style.display='none';if(qs('#rep_pur_item_section'))qs('#rep_pur_item_section').style.display='none';const base='Report → Purchase';const hideMain=()=>{qs('#rep_pur_table')&&(qs('#rep_pur_table').style.display='none');qs('#rep_pur_totals')&&(qs('#rep_pur_totals').style.display='none')};const showMain=()=>{qs('#rep_pur_table')&&(qs('#rep_pur_table').style.display='table');qs('#rep_pur_totals')&&(qs('#rep_pur_totals').style.display='block')};if(kind==='vendor'){qs('#rep_pur_sub_vendor')&&qs('#rep_pur_sub_vendor').classList.add('active');if(qs('#rep_pur_vendor_section'))qs('#rep_pur_vendor_section').style.display='block';if(qs('#rep_pur_path'))qs('#rep_pur_path').textContent=base+' → Purchase by Vendor';hideMain();reportPurchaseByVendor();}else if(kind==='item'){qs('#rep_pur_sub_item')&&qs('#rep_pur_sub_item').classList.add('active');if(qs('#rep_pur_item_section'))qs('#rep_pur_item_section').style.display='block';if(qs('#rep_pur_path'))qs('#rep_pur_path').textContent=base+' → Purchase by Item';hideMain();reportPurchaseByItem();}else{if(qs('#rep_pur_path'))qs('#rep_pur_path').textContent=base;showMain();}}
function reportSalesByCustomer(){fetch('/api/sales/orders').then(r=>r.json()).then(rows=>{const company=(qs('#rep_sales_company')?qs('#rep_sales_company').value.trim():'');const from=(qs('#rep_sales_from')?qs('#rep_sales_from').value:'');const to=(qs('#rep_sales_to')?qs('#rep_sales_to').value:'');const inRange=d=>{if(from&&d<from)return false;if(to&&d>to)return false;return true};const filtered=rows.filter(s=>(!company||s.company_code===company)&&inRange(String(s.date||'')));const by=new Map();filtered.forEach(s=>{const cust=s.customer||'';const lines=(s.lines||[]);let rec=by.get(cust)||{orders:0,qty:0,amt:0};rec.orders++;lines.forEach(l=>{rec.qty+=Number(l.qty||0);rec.amt+=Number(l.qty||0)*Number(l.price||0)});by.set(cust,rec)});const tbody=qs('#rep_sales_by_customer_table tbody');if(!tbody)return;tbody.innerHTML='';let tq=0,ta=0,to=0;[...by.entries()].sort((a,b)=>b[1].amt-a[1].amt).forEach(([cust,rec])=>{to+=rec.orders;tq+=rec.qty;ta+=rec.amt;const tr=document.createElement('tr');tr.innerHTML=`<td>${cust}</td><td>${rec.orders}</td><td>${rec.qty}</td><td>${rec.amt.toFixed(2)}</td>`;tbody.appendChild(tr)});if(qs('#rep_sales_cust_totals'))qs('#rep_sales_cust_totals').textContent=`Totals — Orders: ${to} Qty: ${tq} Amount: ${ta.toFixed(2)}`;}).catch(()=>alert('Network error'))}
function reportSalesByItem(){fetch('/api/sales/orders').then(r=>r.json()).then(rows=>{const company=(qs('#rep_sales_company')?qs('#rep_sales_company').value.trim():'');const from=(qs('#rep_sales_from')?qs('#rep_sales_from').value:'');const to=(qs('#rep_sales_to')?qs('#rep_sales_to').value:'');const inRange=d=>{if(from&&d<from)return false;if(to&&d>to)return false;return true};const filtered=rows.filter(s=>(!company||s.company_code===company)&&inRange(String(s.date||'')));const by=new Map();filtered.forEach(s=>{const lines=(s.lines||[]);const seen=new Set();lines.forEach(l=>{const sku=l.sku||'';let rec=by.get(sku)||{orders:0,qty:0,amt:0};rec.qty+=Number(l.qty||0);rec.amt+=Number(l.qty||0)*Number(l.price||0);if(!seen.has(sku)){rec.orders++;seen.add(sku)}by.set(sku,rec)});});const tbody=qs('#rep_sales_by_item_table tbody');if(!tbody)return;tbody.innerHTML='';let tq=0,ta=0,to=0;[...by.entries()].sort((a,b)=>b[1].amt-a[1].amt).forEach(([sku,rec])=>{to+=rec.orders;tq+=rec.qty;ta+=rec.amt;const tr=document.createElement('tr');tr.innerHTML=`<td>${sku}</td><td>${rec.orders}</td><td>${rec.qty}</td><td>${rec.amt.toFixed(2)}</td>`;tbody.appendChild(tr)});if(qs('#rep_sales_item_totals'))qs('#rep_sales_item_totals').textContent=`Totals — Items: ${by.size} Orders: ${to} Qty: ${tq} Amount: ${ta.toFixed(2)}`;}).catch(()=>alert('Network error'))}
function reportPurchaseByVendor(){fetch('/api/purchase/orders').then(r=>r.json()).then(rows=>{const company=(qs('#rep_pur_company')?qs('#rep_pur_company').value.trim():'');const from=(qs('#rep_pur_from')?qs('#rep_pur_from').value:'');const to=(qs('#rep_pur_to')?qs('#rep_pur_to').value:'');const inRange=d=>{if(from&&d<from)return false;if(to&&d>to)return false;return true};const filtered=rows.filter(p=>(!company||p.company_code===company)&&inRange(String(p.date||'')));const by=new Map();filtered.forEach(p=>{const vendor=p.vendor||'';const lines=(p.lines||[]);let rec=by.get(vendor)||{orders:0,qty:0,amt:0};rec.orders++;lines.forEach(l=>{rec.qty+=Number(l.qty||0);rec.amt+=Number(l.qty||0)*Number(l.price||0)});by.set(vendor,rec)});const tbody=qs('#rep_pur_by_vendor_table tbody');if(!tbody)return;tbody.innerHTML='';let tq=0,ta=0,to=0;[...by.entries()].sort((a,b)=>b[1].amt-a[1].amt).forEach(([ven,rec])=>{to+=rec.orders;tq+=rec.qty;ta+=rec.amt;const tr=document.createElement('tr');tr.innerHTML=`<td>${ven}</td><td>${rec.orders}</td><td>${rec.qty}</td><td>${rec.amt.toFixed(2)}</td>`;tbody.appendChild(tr)});if(qs('#rep_pur_vendor_totals'))qs('#rep_pur_vendor_totals').textContent=`Totals — Orders: ${to} Qty: ${tq} Amount: ${ta.toFixed(2)}`;}).catch(()=>alert('Network error'))}
function reportPurchaseByItem(){fetch('/api/purchase/orders').then(r=>r.json()).then(rows=>{const company=(qs('#rep_pur_company')?qs('#rep_pur_company').value.trim():'');const from=(qs('#rep_pur_from')?qs('#rep_pur_from').value:'');const to=(qs('#rep_pur_to')?qs('#rep_pur_to').value:'');const inRange=d=>{if(from&&d<from)return false;if(to&&d>to)return false;return true};const filtered=rows.filter(p=>(!company||p.company_code===company)&&inRange(String(p.date||'')));const by=new Map();filtered.forEach(p=>{const lines=(p.lines||[]);const seen=new Set();lines.forEach(l=>{const sku=l.sku||'';let rec=by.get(sku)||{orders:0,qty:0,amt:0};rec.qty+=Number(l.qty||0);rec.amt+=Number(l.qty||0)*Number(l.price||0);if(!seen.has(sku)){rec.orders++;seen.add(sku)}by.set(sku,rec)});});const tbody=qs('#rep_pur_by_item_table tbody');if(!tbody)return;tbody.innerHTML='';let tq=0,ta=0,to=0;[...by.entries()].sort((a,b)=>b[1].amt-a[1].amt).forEach(([sku,rec])=>{to+=rec.orders;tq+=rec.qty;ta+=rec.amt;const tr=document.createElement('tr');tr.innerHTML=`<td>${sku}</td><td>${rec.orders}</td><td>${rec.qty}</td><td>${rec.amt.toFixed(2)}</td>`;tbody.appendChild(tr)});if(qs('#rep_pur_item_totals'))qs('#rep_pur_item_totals').textContent=`Totals — Items: ${by.size} Orders: ${to} Qty: ${tq} Amount: ${ta.toFixed(2)}`;}).catch(()=>alert('Network error'))}
